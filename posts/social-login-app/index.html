<!DOCTYPE html><html lang="en" mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="day-prompt" content="days ago"><meta name="hour-prompt" content="hours ago"><meta name="minute-prompt" content="minutes ago"><meta name="justnow-prompt" content="just now"><meta name="generator" content="Jekyll v4.2.1" /><meta property="og:title" content="Writing a React Native App using Expo and Google Social Login" /><meta property="og:locale" content="en" /><meta name="description" content="This will be a brief tutorial on how to write a React Native application, using Expo, that implements Social Authentication, using Google. We will use ExpressJS and Passport in the backend to manage the authentication process. We will assume that the reader is already comfortable with React Native and Express and that they are also proficient with Typescript." /><meta property="og:description" content="This will be a brief tutorial on how to write a React Native application, using Expo, that implements Social Authentication, using Google. We will use ExpressJS and Passport in the backend to manage the authentication process. We will assume that the reader is already comfortable with React Native and Express and that they are also proficient with Typescript." /><link rel="canonical" href="https://sebasgarcep.github.io/posts/social-login-app/" /><meta property="og:url" content="https://sebasgarcep.github.io/posts/social-login-app/" /><meta property="og:site_name" content="Sebastian Garrido" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-01-03T00:00:00-05:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Writing a React Native App using Expo and Google Social Login" /><meta name="twitter:site" content="@twitter_username" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"headline":"Writing a React Native App using Expo and Google Social Login","dateModified":"2022-01-03T00:00:00-05:00","datePublished":"2022-01-03T00:00:00-05:00","description":"This will be a brief tutorial on how to write a React Native application, using Expo, that implements Social Authentication, using Google. We will use ExpressJS and Passport in the backend to manage the authentication process. We will assume that the reader is already comfortable with React Native and Express and that they are also proficient with Typescript.","url":"https://sebasgarcep.github.io/posts/social-login-app/","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://sebasgarcep.github.io/posts/social-login-app/"},"@context":"https://schema.org"}</script><title>Writing a React Native App using Expo and Google Social Login | Sebastian Garrido</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Sebastian Garrido"><meta name="application-name" content="Sebastian Garrido"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end" lang="en"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/profile.jpeg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Sebastian Garrido</a></div><div class="site-subtitle font-italic">Data Engineer</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/sebasgarcep" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://www.linkedin.com/in/sebastian-garrido-cepeda-20b090152/" aria-label="linkedin" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['sebasgarcep','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Writing a React Native App using Expo and Google Social Login</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"> <img data-src="/assets/img/2022-01-03-social-login-app/lock.jpg" class="preview-img bg" alt="Lock on a fence" data-proofer-ignore><h1 data-toc-skip>Writing a React Native App using Expo and Google Social Login</h1><div class="post-meta text-muted"><div> By <em> <a href="https://github.com/sebasgarcep">Sebastian Garrido</a> </em></div><div class="d-flex"><div> <span> Posted <em class="timeago" date="2022-01-03 00:00:00 -0500" data-toggle="tooltip" data-placement="bottom" title="Mon, Jan 3, 2022, 12:00 AM -0500" >Jan 3, 2022</em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2143 words"> <em>11 min</em> read</span></div></div></div><div class="post-content"><p>This will be a brief tutorial on how to write a React Native application, using Expo, that implements Social Authentication, using Google. We will use ExpressJS and Passport in the backend to manage the authentication process. We will assume that the reader is already comfortable with React Native and Express and that they are also proficient with Typescript.</p><h1 id="designing-the-application">Designing the Application</h1><p>Our client wants a mobile application that allows people to login using any of the major social networks and which feeds authenticated users a random message. Because we will set up everything to be easily extensible we will only implement one of the social authentication providers (Google), as that is enough for an exercise. The application must therefore consist of two screens:</p><ul><li>Login screen: where the login workflow occurs.<li>Home screen: where the user can obtain the random message.</ul><p>The backend must implement at least the following two endpoints:</p><ul><li>POST <code class="language-plaintext highlighter-rouge">/api/v1/auth/google</code>: If the login attempt was succesful the mobile device will receive a Google ID token. That token will be sent to this endpoint to trade for a valid session token.<li>GET <code class="language-plaintext highlighter-rouge">/api/v1/message</code>: where authenticated users can obtain a random message.</ul><p>Notice that we do not use the Google ID token as the session token for several reasons. First, it will require us to perform an authentication check on each API call to the Google backend, which will slow down the server response time. Second, Google ID tokens are usually short-lived, so users will be forced to login again after a short amount of time. Third, because we want multiple login providers, trading provider-specific ID tokens for application session tokens simplifies authentication workflows on restricted endpoints.</p><h1 id="creating-the-login-screen">Creating the Login Screen</h1><p>Start by scaffolding a React Native/Expo App with Typescript. You are going to need to run the following command in order to install the necessary dependencies for social authentication.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>expo <span class="nb">install </span>expo-auth-session expo-web-browser expo-random
</pre></table></code></div></div><p>I also like adding React Native Paper for some nice GUI elements, React Navigation for the navigation provider and Redux to use as a global state store.</p><p>Once you are ready, create a <code class="language-plaintext highlighter-rouge">LoginScreen</code> component as follows:</p><div class="language-tsx highlighter-rouge"><div class="code-header"> <span label-text="Tsx"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
</pre><td class="rouge-code"><pre><span class="k">import</span> <span class="p">{</span> <span class="nx">StackScreenProps</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">@react-navigation/stack</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="o">*</span> <span class="k">as</span> <span class="nx">React</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">react</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">StyleSheet</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">react-native</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">Button</span><span class="p">,</span> <span class="nx">Title</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">react-native-paper</span><span class="dl">'</span><span class="p">;</span>

<span class="k">import</span> <span class="nx">Container</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../components/Container</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">RootStackParamList</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../types</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="nx">useGoogleLogin</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../hooks/useGoogleLogin</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">useSession</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../store/selectors/session</span><span class="dl">'</span><span class="p">;</span>
 
<span class="k">export</span> <span class="k">default</span> <span class="kd">function</span> <span class="nx">LoginScreen</span><span class="p">({</span>
    <span class="nx">navigation</span><span class="p">,</span>
<span class="p">}:</span> <span class="nx">StackScreenProps</span><span class="o">&lt;</span><span class="nx">RootStackParamList</span><span class="p">,</span> <span class="dl">'</span><span class="s1">Login</span><span class="dl">'</span><span class="o">&gt;</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">session</span> <span class="o">=</span> <span class="nx">useSession</span><span class="p">();</span>
    <span class="kd">const</span> <span class="p">[</span><span class="nx">loadingGoogleLogin</span><span class="p">,</span> <span class="nx">promptGoogleLogin</span><span class="p">]</span> <span class="o">=</span> <span class="nx">useGoogleLogin</span><span class="p">();</span>

    <span class="nx">React</span><span class="p">.</span><span class="nx">useEffect</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">session</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">navigation</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="dl">'</span><span class="s1">Home</span><span class="dl">'</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">},</span> <span class="p">[</span><span class="nx">session</span><span class="p">]);</span>

    <span class="k">return</span> <span class="p">(</span>
        <span class="p">&lt;</span><span class="nc">Container</span> <span class="na">style</span><span class="p">=</span><span class="si">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">container</span><span class="si">}</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nc">Title</span> <span class="na">style</span><span class="p">=</span><span class="si">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">title</span><span class="si">}</span><span class="p">&gt;</span>Social Login App<span class="p">&lt;/</span><span class="nc">Title</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nc">Button</span>
                <span class="na">disabled</span><span class="p">=</span><span class="si">{</span><span class="nx">loadingGoogleLogin</span><span class="si">}</span>
                <span class="na">icon</span><span class="p">=</span><span class="s">"google"</span>
                <span class="na">mode</span><span class="p">=</span><span class="s">"contained"</span>
                <span class="na">onPress</span><span class="p">=</span><span class="si">{</span><span class="nx">promptGoogleLogin</span><span class="si">}</span>
            <span class="p">&gt;</span>
                Login with Google
            <span class="p">&lt;/</span><span class="nc">Button</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="nc">Container</span><span class="p">&gt;</span>
    <span class="p">);</span>
<span class="p">}</span>

<span class="kd">const</span> <span class="nx">styles</span> <span class="o">=</span> <span class="nx">StyleSheet</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
    <span class="na">container</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">padding</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
        <span class="na">justifyContent</span><span class="p">:</span> <span class="dl">'</span><span class="s1">center</span><span class="dl">'</span><span class="p">,</span>
        <span class="na">alignItems</span><span class="p">:</span> <span class="dl">'</span><span class="s1">center</span><span class="dl">'</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="na">title</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">fontSize</span><span class="p">:</span> <span class="mi">28</span><span class="p">,</span>
        <span class="na">marginBottom</span><span class="p">:</span> <span class="mi">60</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">});</span>
</pre></table></code></div></div><p>The important aspects of this screen are:</p><ul><li><code class="language-plaintext highlighter-rouge">useSession</code> hook: trivial state selector that checks that the session exists in the data store and hasn’t expired. Returns the session if this holds, otherwise it returns null.<li><code class="language-plaintext highlighter-rouge">useGoogleLogin</code> hook: Handles the Google Login logic on the mobile side. Returns two values to be used by the frontend. <code class="language-plaintext highlighter-rouge">loadingGoogleLogin</code> which is a boolean value that tells the frontend whether Google Login is running in the background, and <code class="language-plaintext highlighter-rouge">promptGoogleLogin</code> which triggers the authentication workflow.<li><code class="language-plaintext highlighter-rouge">React.useEffect</code> call: If it observes that the session changes to a non-null value, then it moves the user to the Home screen. Notice that if the application is closed and opened again this piece of code will redirect the user to the Home screen if we persist the data store.</ul><p>Let’s dive deeper into the <code class="language-plaintext highlighter-rouge">useGoogleLogin</code> implementation:</p><div class="language-tsx highlighter-rouge"><div class="code-header"> <span label-text="Tsx"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
</pre><td class="rouge-code"><pre><span class="k">import</span> <span class="o">*</span> <span class="k">as</span> <span class="nx">Google</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">expo-auth-session/providers/google</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="o">*</span> <span class="k">as</span> <span class="nx">WebBrowser</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">expo-web-browser</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="o">*</span> <span class="k">as</span> <span class="nx">React</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">react</span><span class="dl">'</span><span class="p">;</span>

<span class="k">import</span> <span class="p">{</span> <span class="nx">GOOGLE_CLIENT_ID</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../constants/environment</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">loginWithGoogle</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../services/server</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">useLogin</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../store/actions/session</span><span class="dl">'</span><span class="p">;</span>

<span class="nx">WebBrowser</span><span class="p">.</span><span class="nx">maybeCompleteAuthSession</span><span class="p">();</span>

<span class="k">export</span> <span class="k">default</span> <span class="kd">function</span> <span class="nx">useGoogleLogin</span><span class="p">():</span> <span class="p">[</span><span class="nx">boolean</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="kr">any</span><span class="p">]</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">login</span> <span class="o">=</span> <span class="nx">useLogin</span><span class="p">();</span>

    <span class="kd">const</span> <span class="p">[</span><span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="p">,</span> <span class="nx">promptAsync</span><span class="p">]</span> <span class="o">=</span> <span class="nx">Google</span><span class="p">.</span><span class="nx">useIdTokenAuthRequest</span><span class="p">({</span>
        <span class="na">clientId</span><span class="p">:</span> <span class="nx">GOOGLE_CLIENT_ID</span><span class="p">,</span>
    <span class="p">});</span>

    <span class="nx">React</span><span class="p">.</span><span class="nx">useEffect</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">response</span><span class="p">?.</span><span class="kd">type</span> <span class="o">===</span> <span class="dl">"</span><span class="s2">success</span><span class="dl">"</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">const</span> <span class="p">{</span> <span class="na">id_token</span><span class="p">:</span> <span class="nx">idToken</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">response</span><span class="p">.</span><span class="nx">params</span><span class="p">;</span>
            <span class="nx">loginWithGoogle</span><span class="p">(</span><span class="nx">idToken</span><span class="p">)</span>
                <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">session</span> <span class="o">=&gt;</span> <span class="nx">login</span><span class="p">(</span><span class="nx">session</span><span class="p">));</span>
        <span class="p">}</span>
    <span class="p">},</span> <span class="p">[</span><span class="nx">response</span><span class="p">]);</span>

    <span class="kd">const</span> <span class="nx">loading</span> <span class="o">=</span> <span class="o">!</span><span class="nx">request</span><span class="p">;</span>

    <span class="kd">const</span> <span class="nx">prompt</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">promptAsync</span><span class="p">();</span>
    <span class="p">};</span>

    <span class="k">return</span> <span class="p">[</span><span class="nx">loading</span><span class="p">,</span> <span class="nx">prompt</span><span class="p">];</span>
<span class="p">}</span>
</pre></table></code></div></div><p>First notice tha usage of <code class="language-plaintext highlighter-rouge">WebBrowser.maybeCompleteAuthSession()</code>. This is required in certain environments for the authentication procedure to work. In other environments it is a no-op, so it can be added safely.</p><p>First notice the <code class="language-plaintext highlighter-rouge">Google.useIdTokenAuthRequest</code> hook. It takes a configuration object as input, with the only required key being the Google Client ID. To obtain a Google Client ID you need to configure a project in GCP and create a OAuth 2.0 Client ID. Further information in how to set up Google Client IDs can be found <a href="https://docs.expo.dev/guides/authentication/#google">here</a>. Notice that each environment (Expo Go, Android Standalone, iOS Standalone) requires a different key. Make sure to set up your application to use different keys for each <a href="https://docs.expo.dev/guides/environment-variables/">environment</a>.</p><p>The <code class="language-plaintext highlighter-rouge">Google.useIdTokenAuthRequest</code> hook returns three values:</p><ul><li>the <code class="language-plaintext highlighter-rouge">request</code> object if no workflow is in progress, or null otherwise.<li>the <code class="language-plaintext highlighter-rouge">response</code> object after an auth workflow has succeeded or failed.<li>the <code class="language-plaintext highlighter-rouge">promptAsync</code> function that triggers the auth workflow.</ul><p>We need to track the request to determine whether a workflow is in progress. We also have to track the response object to trigger the login action if the workflow succeeds. Finally, we need to return the prompt function to allow consumers of <code class="language-plaintext highlighter-rouge">useGoogleLogin</code> to trigger the authentication procedure.</p><p>Once we have a response with a <code class="language-plaintext highlighter-rouge">success</code> type, we know we have obtained a Google ID token. Now we can use the <code class="language-plaintext highlighter-rouge">loginWithGoogle</code> function to trade it for a valid session token. Once we have a session we have to update the global data store with it. The <code class="language-plaintext highlighter-rouge">useLogin</code> hook returns a <code class="language-plaintext highlighter-rouge">login</code> function that takes a session as input and updates the global data store using said value.</p><p>With all of this we have a working Login screen. Now let’s proceed to the server-side implementation.</p><h1 id="configuring-passport-for-google-auth">Configuring Passport for Google Auth</h1><p>First let’s set up a Node Project with Typescript enabled. Once we have that we can install the following dependencies:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>yarn add debug express morgan cookie-parser passport passport-google-id-token jsonwebtoken passport-jwt
</pre></table></code></div></div><p>We also need to add the following dependencies with the dev flag on so that our typescript compiler will work properly.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>yarn add <span class="nt">-D</span> @types/cookie-parser @types/debug @types/express @types/morgan @types/node @types/passport @types/passport-jwt
</pre></table></code></div></div><p>Sadly, the <code class="language-plaintext highlighter-rouge">passport-google-id-token</code> has no official Typescript bindings at the time of this writing. I had to write my own and put it in the <code class="language-plaintext highlighter-rouge">index.d.ts</code> file at the root of the project. What I ended up using was:</p><div class="language-ts highlighter-rouge"><div class="code-header"> <span label-text="TypeScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre><span class="kr">declare</span> <span class="kr">module</span> <span class="dl">"</span><span class="s2">passport-google-id-token</span><span class="dl">"</span> <span class="p">{</span>
    <span class="k">import</span> <span class="p">{</span> <span class="nx">Strategy</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">passport</span><span class="dl">"</span><span class="p">;</span>
    
    <span class="kd">type</span> <span class="nx">GoogleTokenStrategyOptions</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">clientID</span><span class="p">?:</span> <span class="kr">string</span><span class="p">,</span>
    <span class="p">};</span>

    <span class="kd">type</span> <span class="nx">DoneFunction</span> <span class="o">=</span> <span class="p">(</span><span class="nx">err</span><span class="p">:</span> <span class="nb">Error</span> <span class="o">|</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">user</span><span class="p">?:</span> <span class="kr">any</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="kr">any</span><span class="p">;</span>

    <span class="kd">type</span> <span class="nx">GoogleTokenStrategyCallback</span> <span class="o">=</span> <span class="p">(</span><span class="nx">parsedToken</span><span class="p">:</span> <span class="kr">any</span><span class="p">,</span> <span class="nx">googleId</span><span class="p">:</span> <span class="kr">string</span><span class="p">,</span> <span class="nx">done</span><span class="p">:</span> <span class="nx">DoneFunction</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="kr">any</span><span class="p">;</span>

    <span class="k">export</span> <span class="k">default</span> <span class="kd">class</span> <span class="nx">GoogleTokenStrategy</span> <span class="kd">extends</span> <span class="nx">Strategy</span> <span class="p">{</span>
        <span class="kd">constructor</span><span class="p">(</span><span class="nx">options</span><span class="p">:</span> <span class="nx">GoogleTokenStrategyOptions</span><span class="p">,</span> <span class="nx">callback</span><span class="p">:</span> <span class="nx">GoogleTokenStrategyCallback</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>I’ve also added Prisma to serve as an ORM, Postgres to act as the database and Axios to perform API calls to external services, but you can add whichever services you prefer.</p><p>Now, let’s start by writing a function in <code class="language-plaintext highlighter-rouge">src/app/middleware.ts</code> that adds useful middleware to the Express Application:</p><div class="language-ts highlighter-rouge"><div class="code-header"> <span label-text="TypeScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="k">import</span> <span class="nx">cookieParser</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">cookie-parser</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="nx">express</span><span class="p">,</span> <span class="p">{</span> <span class="nx">Express</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">express</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="nx">logger</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">morgan</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="nx">path</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">path</span><span class="dl">'</span><span class="p">;</span>

<span class="k">export</span> <span class="k">default</span> <span class="kd">function</span><span class="p">(</span><span class="nx">app</span><span class="p">:</span> <span class="nx">Express</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">logger</span><span class="p">(</span><span class="dl">'</span><span class="s1">dev</span><span class="dl">'</span><span class="p">));</span>
    <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="nx">json</span><span class="p">());</span>
    <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="nx">urlencoded</span><span class="p">({</span> <span class="na">extended</span><span class="p">:</span> <span class="kc">false</span> <span class="p">}));</span>
    <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">cookieParser</span><span class="p">());</span>
    <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="k">static</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span> <span class="dl">'</span><span class="s1">public</span><span class="dl">'</span><span class="p">)));</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Now we have to configure Passport. Consider the following function in the file <code class="language-plaintext highlighter-rouge">src/app/passport.ts</code>:</p><div class="language-ts highlighter-rouge"><div class="code-header"> <span label-text="TypeScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
</pre><td class="rouge-code"><pre><span class="k">import</span> <span class="nx">createDebug</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">debug</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">Express</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">express</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="nx">passport</span><span class="p">,</span> <span class="p">{</span> <span class="nx">Strategy</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">passport</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="nx">GoogleTokenStrategy</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">passport-google-id-token</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">Strategy</span> <span class="k">as</span> <span class="nx">JWTStrategy</span><span class="p">,</span> <span class="nx">ExtractJwt</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">passport-jwt</span><span class="dl">'</span><span class="p">;</span>

<span class="k">import</span> <span class="o">*</span> <span class="k">as</span> <span class="nx">User</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../controllers/user</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">Session</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../types</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">GOOGLE_CLIENT_ID</span><span class="p">,</span> <span class="nx">JWT_SECRET</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../values</span><span class="dl">'</span><span class="p">;</span>

<span class="kd">const</span> <span class="nx">debug</span> <span class="o">=</span> <span class="nx">createDebug</span><span class="p">(</span><span class="dl">'</span><span class="s1">social-login-server:app:passport</span><span class="dl">'</span><span class="p">);</span>

<span class="kd">function</span> <span class="nx">getGoogleTokenStrategy</span><span class="p">(</span><span class="nx">clientID</span><span class="p">:</span> <span class="nb">String</span><span class="p">):</span> <span class="nx">Strategy</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">GoogleTokenStrategy</span><span class="p">({</span>
        <span class="nx">clientID</span><span class="p">,</span>
    <span class="p">},</span> <span class="p">(</span><span class="nx">parsedToken</span><span class="p">,</span> <span class="nx">googleId</span><span class="p">,</span> <span class="nx">done</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">debug</span><span class="p">(</span><span class="s2">`Parsed Token: </span><span class="p">${</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">parsedToken</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="mi">4</span><span class="p">)}</span><span class="s2">`</span><span class="p">);</span>
        <span class="nx">debug</span><span class="p">(</span><span class="s2">`Google ID: </span><span class="p">${</span><span class="nx">googleId</span><span class="p">}</span><span class="s2">`</span><span class="p">);</span>
        <span class="nx">User</span><span class="p">.</span><span class="nx">getOrCreateUserByGoogleId</span><span class="p">(</span><span class="nx">googleId</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">user</span> <span class="o">=&gt;</span> <span class="nx">done</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">user</span><span class="p">))</span>
            <span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="nx">err</span> <span class="o">=&gt;</span> <span class="nx">done</span><span class="p">(</span><span class="nx">err</span><span class="p">));</span>
    <span class="p">});</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">getJWTStrategy</span><span class="p">():</span> <span class="nx">Strategy</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">JWTStrategy</span><span class="p">({</span>
        <span class="na">jwtFromRequest</span><span class="p">:</span> <span class="nx">ExtractJwt</span><span class="p">.</span><span class="nx">fromAuthHeaderAsBearerToken</span><span class="p">(),</span>
        <span class="na">secretOrKey</span><span class="p">:</span> <span class="nx">JWT_SECRET</span><span class="p">,</span>
    <span class="p">},</span> <span class="p">(</span><span class="nx">payload</span><span class="p">:</span> <span class="nx">Session</span><span class="p">,</span> <span class="nx">done</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">debug</span><span class="p">(</span><span class="s2">`JWT Payload: </span><span class="p">${</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">payload</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="mi">4</span><span class="p">)}</span><span class="s2">`</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="nx">payload</span><span class="p">.</span><span class="nx">expiresAt</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">done</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">());</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="nx">done</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">payload</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">}</span>

<span class="k">export</span> <span class="k">default</span> <span class="kd">function</span><span class="p">(</span><span class="nx">app</span><span class="p">:</span> <span class="nx">Express</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">passport</span><span class="p">.</span><span class="nx">initialize</span><span class="p">());</span>

    <span class="nx">passport</span><span class="p">.</span><span class="nx">serializeUser</span><span class="p">((</span><span class="nx">user</span><span class="p">,</span> <span class="nx">done</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">done</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">user</span><span class="p">);</span>
    <span class="p">});</span>

    <span class="nx">passport</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="dl">'</span><span class="s1">google-id-token</span><span class="dl">'</span><span class="p">,</span> <span class="nx">getGoogleTokenStrategy</span><span class="p">(</span><span class="nx">GOOGLE_CLIENT_ID</span><span class="p">));</span>
    <span class="nx">passport</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="dl">'</span><span class="s1">jwt</span><span class="dl">'</span><span class="p">,</span> <span class="nx">getJWTStrategy</span><span class="p">());</span>
<span class="p">}</span>
</pre></table></code></div></div><p>First we have to initialize passport with the call <code class="language-plaintext highlighter-rouge">app.use(passport.initialize())</code>. After that we have to add a <code class="language-plaintext highlighter-rouge">serializeUser</code> function to passport. Whenever we login, it transforms the incoming login credentials into a session. We won’t need to do anything here as we will be using the Authentication header, and not cookies. Therefore an identity function will suffice. Finally, we add two strategies to passport:</p><ul><li><code class="language-plaintext highlighter-rouge">GoogleTokenStrategy</code>: Extracts the Google ID token from the body of the request. Specifically, it looks for the <code class="language-plaintext highlighter-rouge">id_token</code> key in the body.<li><code class="language-plaintext highlighter-rouge">JWTStrategy</code>: Parses the session token into a JSON session object using the secret key. We have configured it to extract the session token from the Authentication header using <code class="language-plaintext highlighter-rouge">ExtractJwt.fromAuthHeaderAsBearerToken()</code>.</ul><p>These strategies will add whatever we return using the verify callback to the <code class="language-plaintext highlighter-rouge">req.user</code> property of the request. Now let’s add the routes to the app in <code class="language-plaintext highlighter-rouge">src/app/routes.ts</code>:</p><div class="language-ts highlighter-rouge"><div class="code-header"> <span label-text="TypeScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="k">import</span> <span class="p">{</span> <span class="nx">Express</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">express</span><span class="dl">'</span><span class="p">;</span>

<span class="k">import</span> <span class="nx">authRouter</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../routes/auth</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="nx">messageRouter</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../routes/message</span><span class="dl">'</span><span class="p">;</span>

<span class="k">export</span> <span class="k">default</span> <span class="kd">function</span><span class="p">(</span><span class="nx">app</span><span class="p">:</span> <span class="nx">Express</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="dl">'</span><span class="s1">/api/v1/auth</span><span class="dl">'</span><span class="p">,</span> <span class="nx">authRouter</span><span class="p">);</span>
    <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="dl">'</span><span class="s1">/api/v1/message</span><span class="dl">'</span><span class="p">,</span> <span class="nx">messageRouter</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><p>The authentication router has the following implementation:</p><div class="language-ts highlighter-rouge"><div class="code-header"> <span label-text="TypeScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre><td class="rouge-code"><pre><span class="k">import</span> <span class="p">{</span> <span class="nx">User</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">@prisma/client</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="nx">express</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">express</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="nx">jwt</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">jsonwebtoken</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="nx">passport</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">passport</span><span class="dl">'</span><span class="p">;</span>

<span class="k">import</span> <span class="o">*</span> <span class="k">as</span> <span class="nx">Session</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../controllers/session</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">JWT_SECRET</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../values</span><span class="dl">'</span><span class="p">;</span>

<span class="kd">const</span> <span class="nx">router</span> <span class="o">=</span> <span class="nx">express</span><span class="p">.</span><span class="nx">Router</span><span class="p">();</span>

<span class="nx">router</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="dl">'</span><span class="s1">/google</span><span class="dl">'</span><span class="p">,</span> <span class="nx">passport</span><span class="p">.</span><span class="nx">authenticate</span><span class="p">(</span><span class="dl">'</span><span class="s1">google-id-token</span><span class="dl">'</span><span class="p">),</span> <span class="k">async</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">session</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">Session</span><span class="p">.</span><span class="nx">getSessionByUser</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">user</span> <span class="k">as</span> <span class="nx">User</span><span class="p">);</span>
    <span class="kd">const</span> <span class="nx">credentials</span> <span class="o">=</span> <span class="nx">jwt</span><span class="p">.</span><span class="nx">sign</span><span class="p">(</span><span class="nx">session</span><span class="p">,</span> <span class="nx">JWT_SECRET</span><span class="p">);</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span>
        <span class="na">data</span><span class="p">:</span> <span class="p">{</span>
            <span class="na">scheme</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Bearer</span><span class="dl">'</span><span class="p">,</span>
            <span class="nx">credentials</span><span class="p">,</span>
            <span class="na">expiresAt</span><span class="p">:</span> <span class="nx">session</span><span class="p">.</span><span class="nx">expiresAt</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">});</span>
<span class="p">});</span>

<span class="k">export</span> <span class="k">default</span> <span class="nx">router</span><span class="p">;</span>
</pre></table></code></div></div><p>Notice that between the path and the callback we add a <code class="language-plaintext highlighter-rouge">passport.authenticate</code> call to tell the application to enforce the <code class="language-plaintext highlighter-rouge">google-id-token</code> authentication method for this endpoint. Simple as that. If the Google ID token is valid, the callback will run, otherwise it will return a 401 error code.</p><p>With that done, we build a session object and convert it into a valid JSON Web Token. The consumer of this endpoint will want to know the scheme used in the Authentication header (Bearer in this case), the session token (which we send in the credentials property), and when the session expires to improve the user experience.</p><p>There is a small caveat to add at this point. Notice that for each of the three possible environments we have mentioned we are going to need different Google Client IDs. But we have used a single one up until now. To work around this issue we can create one authentication strategy for each environment:</p><div class="language-ts highlighter-rouge"><div class="code-header"> <span label-text="TypeScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nx">passport</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="dl">'</span><span class="s1">google-id-token-&lt;env&gt;</span><span class="dl">'</span><span class="p">,</span> <span class="nx">getGoogleTokenStrategy</span><span class="p">(</span><span class="nx">GOOGLE_CLIENT_ID_</span><span class="o">&lt;</span><span class="nx">ENV</span><span class="o">&gt;</span><span class="p">));</span>
</pre></table></code></div></div><p>And create one endpoint for each environment using each of these strategies.</p><p>Now let’s move to the message router:</p><div class="language-ts highlighter-rouge"><div class="code-header"> <span label-text="TypeScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre><span class="k">import</span> <span class="nx">express</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">express</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="nx">passport</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">passport</span><span class="dl">'</span><span class="p">;</span>

<span class="k">import</span> <span class="o">*</span> <span class="k">as</span> <span class="nx">Message</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../controllers/message</span><span class="dl">'</span><span class="p">;</span>

<span class="kd">const</span> <span class="nx">router</span> <span class="o">=</span> <span class="nx">express</span><span class="p">.</span><span class="nx">Router</span><span class="p">();</span>

<span class="nx">router</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">passport</span><span class="p">.</span><span class="nx">authenticate</span><span class="p">(</span><span class="dl">'</span><span class="s1">jwt</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span> <span class="na">session</span><span class="p">:</span> <span class="kc">false</span> <span class="p">}));</span>

<span class="nx">router</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/</span><span class="dl">'</span><span class="p">,</span> <span class="k">async</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">message</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">Message</span><span class="p">.</span><span class="nx">getRandomMessage</span><span class="p">();</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span>
        <span class="na">data</span><span class="p">:</span> <span class="p">{</span> <span class="nx">message</span> <span class="p">},</span>
    <span class="p">});</span>
<span class="p">});</span>

<span class="k">export</span> <span class="k">default</span> <span class="nx">router</span><span class="p">;</span>
</pre></table></code></div></div><p>Because we expect all endpoints to be secured for this part of the application, we enforce JWT authentication at router level with the line:</p><div class="language-ts highlighter-rouge"><div class="code-header"> <span label-text="TypeScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nx">router</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">passport</span><span class="p">.</span><span class="nx">authenticate</span><span class="p">(</span><span class="dl">'</span><span class="s1">jwt</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span> <span class="na">session</span><span class="p">:</span> <span class="kc">false</span> <span class="p">}));</span>
</pre></table></code></div></div><p>Everything after that is business logic.</p><h1 id="results">Results</h1><p>At this point we have a working Login Screen that allows logging in using Google.</p><p><img data-src="/assets/img/2022-01-03-social-login-app/screenshot_login.jpg" alt="Login Screen" width="200" data-proofer-ignore></p><p>Moreover, we have a Home Screen that shows authenticated users a random message from the server.</p><p><img data-src="/assets/img/2022-01-03-social-login-app/screenshot_home.jpg" alt="Home Screen" width="200" data-proofer-ignore></p><p>At which point we are done with the tutorial.</p><h1 id="sources">Sources</h1><ul><li><a href="https://github.com/sebasgarcep/social-login-app">React Native Application</a><li><a href="https://github.com/sebasgarcep/social-login-server">Express Application</a></ul></div><div class="post-tail-wrapper text-muted"><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/software-engineering/" class="post-tag no-text-decoration" >Software Engineering</a> <a href="/tags/react-native/" class="post-tag no-text-decoration" >React Native</a> <a href="/tags/expo/" class="post-tag no-text-decoration" >Expo</a> <a href="/tags/social-login/" class="post-tag no-text-decoration" >Social Login</a> <a href="/tags/express/" class="post-tag no-text-decoration" >Express</a> <a href="/tags/passport/" class="post-tag no-text-decoration" >Passport</a> <a href="/tags/google/" class="post-tag no-text-decoration" >Google</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Writing a React Native App using Expo and Google Social Login - Sebastian Garrido&url=https://sebasgarcep.github.io/posts/social-login-app/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Writing a React Native App using Expo and Google Social Login - Sebastian Garrido&u=https://sebasgarcep.github.io/posts/social-login-app/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Writing a React Native App using Expo and Google Social Login - Sebastian Garrido&url=https://sebasgarcep.github.io/posts/social-login-app/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https://sebasgarcep.github.io/posts/social-login-app/" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recent Update</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/from-zero-to-data-ready-part-1/">From Zero to Data-Ready (Part 1): Exploratory Data Analysis</a><li><a href="/posts/from-zero-to-data-ready-part-2/">From Zero to Data-Ready (Part 2): Building a SQL Data Warehouse</a><li><a href="/posts/from-zero-to-data-ready-part-3/">From Zero to Data-Ready (Part 3): Writing Test Driven ETLs using Python</a><li><a href="/posts/from-zero-to-data-ready-part-4/">From Zero to Data-Ready (Part 4): Building Analytics Dashboards using CubeJS and React</a><li><a href="/posts/counting-primes-really-fast/">Counting Primes Really Fast</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/data-engineering/">Data Engineering</a> <a class="post-tag" href="/tags/from-zero-to-data-ready/">From Zero to Data-Ready</a> <a class="post-tag" href="/tags/retail-project/">Retail Project</a> <a class="post-tag" href="/tags/mathematics/">Mathematics</a> <a class="post-tag" href="/tags/postgres/">Postgres</a> <a class="post-tag" href="/tags/python/">Python</a> <a class="post-tag" href="/tags/rust/">Rust</a> <a class="post-tag" href="/tags/sql/">SQL</a> <a class="post-tag" href="/tags/cubejs/">CubeJS</a> <a class="post-tag" href="/tags/data-assimilation/">Data Assimilation</a></div></div></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/kalman-filter-tutorial/"><div class="card-body"> <em class="timeago small" date="2022-01-08 00:00:00 -0500" >Jan 8, 2022</em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Understanding the Kalman Filter</h3><div class="text-muted small"><p> Society depends on having correct estimates of what may happen. Whether it is the climate or traffic, humans have built models of reality which help us make better decisions. But any model is bound...</p></div></div></a></div><div class="card"> <a href="/posts/counting-primes-really-fast/"><div class="card-body"> <em class="timeago small" date="2021-06-28 00:00:00 -0500" >Jun 28, 2021</em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Counting Primes Really Fast</h3><div class="text-muted small"><p> Suppose you are given a very large number, for example $n = 10^{12}$, and you wish to know how many numbers equal to or less than $n$ are prime. This is the prime counting function, normally denote...</p></div></div></a></div><div class="card"> <a href="/posts/from-zero-to-data-ready-part-4/"><div class="card-body"> <em class="timeago small" date="2021-06-18 00:00:00 -0500" >Jun 18, 2021</em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>From Zero to Data-Ready (Part 4): Building Analytics Dashboards using CubeJS and React</h3><div class="text-muted small"><p> In Part 3 we wrote our ETLs using Python and TDD. In this post we will focus on building an analytics platform for the company using CubeJS. What is CubeJS ? CubeJS is a tool that serves as a bac...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/counting-primes-really-fast/" class="btn btn-outline-primary" prompt="Older"><p>Counting Primes Really Fast</p></a> <a href="/posts/kalman-filter-tutorial/" class="btn btn-outline-primary" prompt="Newer"><p>Understanding the Kalman Filter</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2024 <a href="https://github.com/sebasgarcep">Sebastian Garrido</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/data-engineering/">Data Engineering</a> <a class="post-tag" href="/tags/from-zero-to-data-ready/">From Zero to Data-Ready</a> <a class="post-tag" href="/tags/retail-project/">Retail Project</a> <a class="post-tag" href="/tags/mathematics/">Mathematics</a> <a class="post-tag" href="/tags/postgres/">Postgres</a> <a class="post-tag" href="/tags/python/">Python</a> <a class="post-tag" href="/tags/rust/">Rust</a> <a class="post-tag" href="/tags/sql/">SQL</a> <a class="post-tag" href="/tags/cubejs/">CubeJS</a> <a class="post-tag" href="/tags/data-assimilation/">Data Assimilation</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script>
