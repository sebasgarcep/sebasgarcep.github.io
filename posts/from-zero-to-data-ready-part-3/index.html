<!DOCTYPE html><html lang="en" mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="day-prompt" content="days ago"><meta name="hour-prompt" content="hours ago"><meta name="minute-prompt" content="minutes ago"><meta name="justnow-prompt" content="just now"><meta name="generator" content="Jekyll v4.2.1" /><meta property="og:title" content="From Zero to Data-Ready (Part 3): Writing Test Driven ETLs using Python" /><meta property="og:locale" content="en" /><meta name="description" content="In Part 2 we created a data warehouse using sqitch. In this post we will focus on creating ETLs for our data. We will build our ETLs using Python under a Test Driven Development paradigm." /><meta property="og:description" content="In Part 2 we created a data warehouse using sqitch. In this post we will focus on creating ETLs for our data. We will build our ETLs using Python under a Test Driven Development paradigm." /><link rel="canonical" href="https://sebasgarcep.github.io/posts/from-zero-to-data-ready-part-3/" /><meta property="og:url" content="https://sebasgarcep.github.io/posts/from-zero-to-data-ready-part-3/" /><meta property="og:site_name" content="Sebastian Garrido" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-06-01T00:00:00-05:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="From Zero to Data-Ready (Part 3): Writing Test Driven ETLs using Python" /><meta name="twitter:site" content="@twitter_username" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"headline":"From Zero to Data-Ready (Part 3): Writing Test Driven ETLs using Python","dateModified":"2022-01-04T23:08:51-05:00","datePublished":"2021-06-01T00:00:00-05:00","description":"In Part 2 we created a data warehouse using sqitch. In this post we will focus on creating ETLs for our data. We will build our ETLs using Python under a Test Driven Development paradigm.","url":"https://sebasgarcep.github.io/posts/from-zero-to-data-ready-part-3/","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://sebasgarcep.github.io/posts/from-zero-to-data-ready-part-3/"},"@context":"https://schema.org"}</script><title>From Zero to Data-Ready (Part 3): Writing Test Driven ETLs using Python | Sebastian Garrido</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Sebastian Garrido"><meta name="application-name" content="Sebastian Garrido"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end" lang="en"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/profile.jpeg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Sebastian Garrido</a></div><div class="site-subtitle font-italic">Data Engineer</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/sebasgarcep" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://www.linkedin.com/in/sebastian-garrido-cepeda-20b090152/" aria-label="linkedin" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['sebasgarcep','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>From Zero to Data-Ready (Part 3): Writing Test Driven ETLs using Python</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"> <img data-src="/assets/img/2021-06-01-from-zero-to-data-ready-part-3/code.jpg" class="preview-img bg" alt="Code" data-proofer-ignore><h1 data-toc-skip>From Zero to Data-Ready (Part 3): Writing Test Driven ETLs using Python</h1><div class="post-meta text-muted"><div> By <em> <a href="https://github.com/sebasgarcep">Sebastian Garrido</a> </em></div><div class="d-flex"><div> <span> Posted <em class="timeago" date="2021-06-01 00:00:00 -0500" data-toggle="tooltip" data-placement="bottom" title="Tue, Jun 1, 2021, 12:00 AM -0500" >Jun 1, 2021</em> </span> <span> Updated <em class="timeago" date="2022-01-04 23:08:51 -0500 " data-toggle="tooltip" data-placement="bottom" title="Tue, Jan 4, 2022, 11:08 PM -0500" >Jan 4, 2022</em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1526 words"> <em>8 min</em> read</span></div></div></div><div class="post-content"><p>In <a href="/posts/from-zero-to-data-ready-part-2/">Part 2</a> we created a data warehouse using sqitch. In this post we will focus on creating ETLs for our data. We will build our ETLs using Python under a Test Driven Development paradigm.</p><h1 id="testing-our-data-pipelines">Testing our Data Pipelines</h1><p>Test Driven Development is a programming paradigm that emphasizes writing tests for each of the important aspects of our application before we even write the first line of code. The reasoning is that the tests serve as a specification of how the application or its components should behave. Therefore once the tests pass we know that the application is correct.</p><p>In real life, testing is never this easy though. Programs often have to make calls to external services we do not control. Thankfully, any robust testing framework should provide ways to either mock or intercept calls to the external environment. With this in mind, good tests are those that make sure that external services were called appropiately and that any internal state modification left the application in a correct state.</p><p>We need to build three data pipelines:</p><ul><li><code class="language-plaintext highlighter-rouge">process_raw_dump</code>: takes the <code class="language-plaintext highlighter-rouge">database.mdb</code> file and extracts all <code class="language-plaintext highlighter-rouge">.csv</code> files from it. These files are then written to a bucket in Google Cloud Storage.<li><code class="language-plaintext highlighter-rouge">process_csv_dump</code>: downloads the <code class="language-plaintext highlighter-rouge">.csv</code> files from the bucket, cleans the data, and uploads it to the <code class="language-plaintext highlighter-rouge">staging</code> schema of the data warehouse.<li><code class="language-plaintext highlighter-rouge">populate_warehouse</code>: populates the <code class="language-plaintext highlighter-rouge">public</code> schema of the data warehouse using the tables from the <code class="language-plaintext highlighter-rouge">staging</code> schema.</ul><p>All our pipelines will make use of Dependency Injection (DI) to simplify testing. For the uninitiated, DI is a design pattern where side effects are encapsulated into special objects. Whenever a functions needs to produce a specific side effect it asks for the object that encapsulates it as a parameter. To illustrate, assume the following function:</p><div class="language-python highlighter-rouge"><div class="code-header"> <span label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">cache</span>
<span class="kn">import</span> <span class="nn">server</span>

<span class="k">def</span> <span class="nf">is_user_tall</span><span class="p">(</span><span class="n">user_id</span><span class="p">):</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">cache</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">user</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">server</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">user</span><span class="p">.</span><span class="n">height</span> <span class="o">&gt;=</span> <span class="mf">2.0</span>
</pre></table></code></div></div><p>Testing this function would be hard, we would have to intercept the <code class="language-plaintext highlighter-rouge">cache</code> and <code class="language-plaintext highlighter-rouge">server</code> imports to test them. We can rewrite it instead as:</p><div class="language-python highlighter-rouge"><div class="code-header"> <span label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">is_user_tall</span><span class="p">(</span><span class="n">cache</span><span class="p">,</span> <span class="n">server</span><span class="p">,</span> <span class="n">user_id</span><span class="p">):</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">cache</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">user</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">server</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">user</span><span class="p">.</span><span class="n">height</span> <span class="o">&gt;=</span> <span class="mf">2.0</span>
</pre></table></code></div></div><p>The behaviour should stay the same. So long as we remember to pass the <code class="language-plaintext highlighter-rouge">cache</code> and <code class="language-plaintext highlighter-rouge">server</code> objects nothing should break in our application. On the other hand, this makes testing easier, as we can effectively mock the <code class="language-plaintext highlighter-rouge">cache</code> and the <code class="language-plaintext highlighter-rouge">server</code> during testing, and write separate tests to verify the correctness of these objects.</p><p>Let’s begin by establishing a directory structure for our project:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre>src/
    jobs/
        ...
    utils/
        ...
    ...
tests/
    jobs/
        ...
    utils/
        ...
main.py
</pre></table></code></div></div><p>The <code class="language-plaintext highlighter-rouge">main.py</code> file will serve as the entry point for our application. All files in <code class="language-plaintext highlighter-rouge">src/</code> will have a corresponding file in <code class="language-plaintext highlighter-rouge">tests/</code> testing its correctness. We will be using <code class="language-plaintext highlighter-rouge">unittest</code> to write our tests. This library comes with Python 3, so no setup is required. It automatically discovers tests in the source code by looking for files that start with <code class="language-plaintext highlighter-rouge">test_</code>. In each file it looks for functions prefixed with <code class="language-plaintext highlighter-rouge">test_</code> and classes prefixed with <code class="language-plaintext highlighter-rouge">Test</code>. It will recognize these as the tests and run them.</p><p>Each job is gonna be a function that receives a <code class="language-plaintext highlighter-rouge">context</code> object as input. The <code class="language-plaintext highlighter-rouge">context</code> object serves as a wrapper for all injected dependencies. In our cases, these dependencies manage interactions with each of the following:</p><ul><li>Google Cloud Storage<li>Local Environment (Filesystem / Environment variables)<li><code class="language-plaintext highlighter-rouge">mdbtools</code><li>Data Warehouse (PostgreSQL)</ul><p>Let’s begin by writing a test for the Local Environment dependency. Specifically, let’s test the <code class="language-plaintext highlighter-rouge">get_jobs</code> function, which should read a comma-separated list of jobs to execute from the <code class="language-plaintext highlighter-rouge">JOBS</code> env variable, and should return a list of job names:</p><div class="language-python highlighter-rouge"><div class="code-header"> <span label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">unittest</span>
<span class="kn">from</span> <span class="nn">src.utils.environment</span> <span class="kn">import</span> <span class="n">Environment</span>

<span class="k">class</span> <span class="nc">TestEnvironment</span><span class="p">(</span><span class="n">unittest</span><span class="p">.</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="n">environment</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">environment</span> <span class="o">=</span> <span class="n">Environment</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">test_get_jobs_undefined</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""
        should return empty list if jobs env variable is None (undefined)
        """</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">environment</span><span class="p">.</span><span class="n">get_jobs</span><span class="p">()</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="p">[])</span>

    <span class="k">def</span> <span class="nf">test_get_jobs_defined</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""
        should return list of jobs from comma-separated env variable
        """</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">environment</span><span class="p">.</span><span class="n">get_jobs</span><span class="p">()</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="p">[</span><span class="s">"job1"</span><span class="p">,</span> <span class="s">"job2"</span><span class="p">])</span>
</pre></table></code></div></div><p>Notice that both of these tests cannot pass at the same time, as our tests will run with the <code class="language-plaintext highlighter-rouge">JOBS</code> env variable either defined or undefined. Moreover, these tests have one big issue: They have side-effects! For our small project this is not a problem, but on a larger project side effects slow down tests considerably, and can break stuff if the developer is not careful. Therefore we want our tests to lack side effects, if only for the sake of sanity.</p><p>One solution is to patch calls to <code class="language-plaintext highlighter-rouge">os.environ.get</code>, to make sure it returns what we want on each specific test without having to look things up in the local system.</p><div class="language-python highlighter-rouge"><div class="code-header"> <span label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">unittest</span>
<span class="kn">from</span> <span class="nn">unittest.mock</span> <span class="kn">import</span> <span class="n">patch</span>
<span class="kn">from</span> <span class="nn">src.utils.environment</span> <span class="kn">import</span> <span class="n">Environment</span>

<span class="k">class</span> <span class="nc">TestEnvironment</span><span class="p">(</span><span class="n">unittest</span><span class="p">.</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="n">environment</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">environment</span> <span class="o">=</span> <span class="n">Environment</span><span class="p">()</span>

    <span class="o">@</span><span class="n">patch</span><span class="p">(</span>
        <span class="s">"src.utils.environment.os.environ.get"</span><span class="p">,</span>
        <span class="k">lambda</span> <span class="n">key</span><span class="p">:</span> <span class="bp">None</span>
    <span class="p">)</span>
    <span class="k">def</span> <span class="nf">test_get_jobs_undefined</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""
        should return empty list if jobs env variable is None (undefined)
        """</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">environment</span><span class="p">.</span><span class="n">get_jobs</span><span class="p">()</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="p">[])</span>

    <span class="o">@</span><span class="n">patch</span><span class="p">(</span>
        <span class="s">"src.utils.environment.os.environ.get"</span><span class="p">,</span>
        <span class="k">lambda</span> <span class="n">key</span><span class="p">:</span> <span class="s">"job1,job2"</span>
    <span class="p">)</span>
    <span class="k">def</span> <span class="nf">test_get_jobs_defined</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""
        should return list of jobs from comma-separated env variable
        """</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">environment</span><span class="p">.</span><span class="n">get_jobs</span><span class="p">()</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="p">[</span><span class="s">"job1"</span><span class="p">,</span> <span class="s">"job2"</span><span class="p">])</span>
</pre></table></code></div></div><p>Now both tests can pass and there are no side effects. All the other tests for injected dependencies follow a similar pattern, so we won’t elaborate further on them.</p><p>Let’s write a test for <code class="language-plaintext highlighter-rouge">process_raw_dump</code>. This pipeline’s only job is to export tables from a downloaded <code class="language-plaintext highlighter-rouge">.mdb</code> file and upload them to Google Cloud Storage. Assume we already have implemented and tested the following functions:</p><ul><li><code class="language-plaintext highlighter-rouge">context.environment.create_blank_directory</code>: Creates a blank directory at the given path<li><code class="language-plaintext highlighter-rouge">context.cloud.download_file</code>: Downloads a given file from Google Cloud Storage<li><code class="language-plaintext highlighter-rouge">context.mdbtools.dump_tables</code>: Exports a whole database from an <code class="language-plaintext highlighter-rouge">.mdb</code> file to the local filesystem<li><code class="language-plaintext highlighter-rouge">context.cloud.upload_bucket</code>: Uploads a whole folder to Google Cloud Storage</ul><p>Therefore, we only need to test that these functions are being called appropiately and in the correct order. The final result looks like this:</p><div class="language-python highlighter-rouge"><div class="code-header"> <span label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">unittest</span>
<span class="kn">from</span> <span class="nn">unittest.mock</span> <span class="kn">import</span> <span class="n">call</span><span class="p">,</span> <span class="n">Mock</span>
<span class="kn">from</span> <span class="nn">src.jobs.process_raw_dump</span> <span class="kn">import</span> <span class="n">process_raw_dump</span>

<span class="k">class</span> <span class="nc">TestProcessRawDump</span><span class="p">(</span><span class="n">unittest</span><span class="p">.</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">test_process</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""
        should correctly process the mdb dump in cloud storage and upload the exported csvs
        """</span>
        <span class="n">context_calls</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">context</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
        <span class="n">context</span><span class="p">.</span><span class="n">environment</span><span class="p">.</span><span class="n">create_blank_directory</span><span class="p">.</span><span class="n">side_effect</span> <span class="o">=</span> \
            <span class="k">lambda</span> <span class="n">dirname</span><span class="p">:</span> <span class="n">context_calls</span><span class="p">.</span><span class="n">append</span><span class="p">((</span><span class="s">"environment.create_blank_directory"</span><span class="p">,</span> <span class="n">dirname</span><span class="p">))</span>
        <span class="n">context</span><span class="p">.</span><span class="n">cloud</span><span class="p">.</span><span class="n">download_file</span><span class="p">.</span><span class="n">side_effect</span> <span class="o">=</span> \
            <span class="k">lambda</span> <span class="n">bucket</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="n">context_calls</span><span class="p">.</span><span class="n">append</span><span class="p">((</span><span class="s">"cloud.download_file"</span><span class="p">,</span> <span class="n">bucket</span><span class="p">,</span> <span class="n">filename</span><span class="p">))</span>
        <span class="n">context</span><span class="p">.</span><span class="n">mdbtools</span><span class="p">.</span><span class="n">dump_tables</span><span class="p">.</span><span class="n">side_effect</span> <span class="o">=</span> \
            <span class="k">lambda</span> <span class="n">filename</span><span class="p">,</span> <span class="n">folder_path</span><span class="p">:</span> <span class="n">context_calls</span><span class="p">.</span><span class="n">append</span><span class="p">((</span><span class="s">"mdbtools.dump_tables"</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">folder_path</span><span class="p">))</span>
        <span class="n">context</span><span class="p">.</span><span class="n">cloud</span><span class="p">.</span><span class="n">upload_bucket</span><span class="p">.</span><span class="n">side_effect</span> <span class="o">=</span> \
            <span class="k">lambda</span> <span class="n">bucket</span><span class="p">:</span> <span class="n">context_calls</span><span class="p">.</span><span class="n">append</span><span class="p">((</span><span class="s">"cloud.upload_bucket"</span><span class="p">,</span> <span class="n">bucket</span><span class="p">))</span>

        <span class="n">process_raw_dump</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>

        <span class="n">expected_calls</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="s">"environment.create_blank_directory"</span><span class="p">,</span> <span class="s">"mdb_store"</span><span class="p">),</span>
            <span class="p">(</span><span class="s">"environment.create_blank_directory"</span><span class="p">,</span> <span class="s">"csv_tables_store"</span><span class="p">),</span>
            <span class="p">(</span><span class="s">"cloud.download_file"</span><span class="p">,</span> <span class="s">"mdb_store"</span><span class="p">,</span> <span class="s">"database.mdb"</span><span class="p">),</span>
            <span class="p">(</span><span class="s">"mdbtools.dump_tables"</span><span class="p">,</span> <span class="s">"mdb_store/database.mdb"</span><span class="p">,</span> <span class="s">"csv_tables_store"</span><span class="p">),</span>
            <span class="p">(</span><span class="s">"cloud.upload_bucket"</span><span class="p">,</span> <span class="s">"csv_tables_store"</span><span class="p">)</span>
        <span class="p">]</span>

        <span class="bp">self</span><span class="p">.</span><span class="n">assertListEqual</span><span class="p">(</span><span class="n">context_calls</span><span class="p">,</span> <span class="n">expected_calls</span><span class="p">)</span>
</pre></table></code></div></div><p>We could’ve gone the extra mile to mock Google Cloud, and tested whether the <code class="language-plaintext highlighter-rouge">.csv</code> files in the mocked Google Cloud are correct at the end of the job. We finally opted not to, as this would’ve been cumbersome to write. Instead we opted for tests that leak elements of our implementation. In the end, software engineering is about tradeoffs, and in this case we choose to have leaky tests for the sake of having unit tests that are simpler to write.</p><p>The tests for the other pipelines follow a similar pattern, so they are not worth discussing.</p><h1 id="building-our-data-pipelines">Building our Data Pipelines</h1><p>Finally, building our data pipelines is relatively trivial. The first part is writing a framework to run our pipelines. We implement a <code class="language-plaintext highlighter-rouge">Runner</code> class where we register the jobs and our context object:</p><div class="language-python highlighter-rouge"><div class="code-header"> <span label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre><span class="kn">from</span> <span class="nn">src.jobs.populate_warehouse</span> <span class="kn">import</span> <span class="n">populate_warehouse</span>
<span class="kn">from</span> <span class="nn">src.jobs.process_csv_dump</span> <span class="kn">import</span> <span class="n">process_csv_dump</span>
<span class="kn">from</span> <span class="nn">src.jobs.process_raw_dump</span> <span class="kn">import</span> <span class="n">process_raw_dump</span>
<span class="kn">from</span> <span class="nn">src.utils.runner</span> <span class="kn">import</span> <span class="n">Runner</span>
<span class="kn">from</span> <span class="nn">src.utils.context</span> <span class="kn">import</span> <span class="n">Context</span>

<span class="n">runner</span> <span class="o">=</span> <span class="n">Runner</span><span class="p">()</span>
<span class="n">runner</span><span class="p">.</span><span class="n">register_job</span><span class="p">(</span><span class="s">"process_raw_dump"</span><span class="p">,</span> <span class="n">process_raw_dump</span><span class="p">)</span>
<span class="n">runner</span><span class="p">.</span><span class="n">register_job</span><span class="p">(</span><span class="s">"process_csv_dump"</span><span class="p">,</span> <span class="n">process_csv_dump</span><span class="p">)</span>
<span class="n">runner</span><span class="p">.</span><span class="n">register_job</span><span class="p">(</span><span class="s">"populate_warehouse"</span><span class="p">,</span> <span class="n">populate_warehouse</span><span class="p">)</span>

<span class="n">context</span> <span class="o">=</span> <span class="n">Context</span><span class="p">()</span>
<span class="n">runner</span><span class="p">.</span><span class="n">set_context</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>

<span class="n">runner</span><span class="p">.</span><span class="n">run_jobs</span><span class="p">()</span>
</pre></table></code></div></div><p>Finally, we want to be able to dynamically change the jobs we want to run. In particular, we want to be able to run commands like:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nv">JOBS</span><span class="o">=</span>process_csv_dump,populate_warehouse python3 ./main.py
</pre></table></code></div></div><p>and have the framework run only thos jobs. To this effect we implement a simple <code class="language-plaintext highlighter-rouge">run_jobs</code> function that takes no arguments and handles the logic of reading the <code class="language-plaintext highlighter-rouge">JOBS</code> environment variable and triggering the right jobs. All of this is also implemented using the TDD paradigm to assure the correctness of our implementation.</p><p>The final part is implementing the data pipelines. There is nothing to note about this process, so if the reader is interested in them, their implementation can be found in the source code for the project.</p><h1 id="up-next">Up Next</h1><p>Now that our data warehouse has been populated, we have most of the required infrastructure in place. We are only missing a Business Intelligence tool in our stack. In <a href="/posts/from-zero-to-data-ready-part-4/">Part 4</a> we will build it using CubeJS. Stay tuned!</p><h2 id="sources">Sources<a href="#sources" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><ul><li><a href="https://github.com/sebasgarcep/from_zero_to_data_ready">From Zero to Data Ready project</a></ul></div><div class="post-tail-wrapper text-muted"><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/data-engineering/" class="post-tag no-text-decoration" >Data Engineering</a> <a href="/tags/retail-project/" class="post-tag no-text-decoration" >Retail Project</a> <a href="/tags/from-zero-to-data-ready/" class="post-tag no-text-decoration" >From Zero to Data-Ready</a> <a href="/tags/python/" class="post-tag no-text-decoration" >Python</a> <a href="/tags/test-driven-development/" class="post-tag no-text-decoration" >Test Driven Development</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=From Zero to Data-Ready (Part 3): Writing Test Driven ETLs using Python - Sebastian Garrido&url=https://sebasgarcep.github.io/posts/from-zero-to-data-ready-part-3/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=From Zero to Data-Ready (Part 3): Writing Test Driven ETLs using Python - Sebastian Garrido&u=https://sebasgarcep.github.io/posts/from-zero-to-data-ready-part-3/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=From Zero to Data-Ready (Part 3): Writing Test Driven ETLs using Python - Sebastian Garrido&url=https://sebasgarcep.github.io/posts/from-zero-to-data-ready-part-3/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https://sebasgarcep.github.io/posts/from-zero-to-data-ready-part-3/" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recent Update</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/from-zero-to-data-ready-part-1/">From Zero to Data-Ready (Part 1): Exploratory Data Analysis</a><li><a href="/posts/from-zero-to-data-ready-part-2/">From Zero to Data-Ready (Part 2): Building a SQL Data Warehouse</a><li><a href="/posts/from-zero-to-data-ready-part-3/">From Zero to Data-Ready (Part 3): Writing Test Driven ETLs using Python</a><li><a href="/posts/from-zero-to-data-ready-part-4/">From Zero to Data-Ready (Part 4): Building Analytics Dashboards using CubeJS and React</a><li><a href="/posts/counting-primes-really-fast/">Counting Primes Really Fast</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/data-engineering/">Data Engineering</a> <a class="post-tag" href="/tags/from-zero-to-data-ready/">From Zero to Data-Ready</a> <a class="post-tag" href="/tags/retail-project/">Retail Project</a> <a class="post-tag" href="/tags/mathematics/">Mathematics</a> <a class="post-tag" href="/tags/postgres/">Postgres</a> <a class="post-tag" href="/tags/python/">Python</a> <a class="post-tag" href="/tags/rust/">Rust</a> <a class="post-tag" href="/tags/sql/">SQL</a> <a class="post-tag" href="/tags/cubejs/">CubeJS</a> <a class="post-tag" href="/tags/data-assimilation/">Data Assimilation</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/from-zero-to-data-ready-part-1/"><div class="card-body"> <em class="timeago small" date="2021-05-30 00:00:00 -0500" >May 30, 2021</em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>From Zero to Data-Ready (Part 1): Exploratory Data Analysis</h3><div class="text-muted small"><p> Data science has been all the rage for a while. This is no accident: data science, done well, provides insights that give businesses the competitive edge you need nowadays to survive. What very few...</p></div></div></a></div><div class="card"> <a href="/posts/from-zero-to-data-ready-part-2/"><div class="card-body"> <em class="timeago small" date="2021-05-31 00:00:00 -0500" >May 31, 2021</em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>From Zero to Data-Ready (Part 2): Building a SQL Data Warehouse</h3><div class="text-muted small"><p> In Part 1 we defined our problem, performed some EDA and defined a data model appropiate for data analytic purposes. In this post we will explore how to build a data warehouse and ETLs using Test D...</p></div></div></a></div><div class="card"> <a href="/posts/from-zero-to-data-ready-part-4/"><div class="card-body"> <em class="timeago small" date="2021-06-18 00:00:00 -0500" >Jun 18, 2021</em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>From Zero to Data-Ready (Part 4): Building Analytics Dashboards using CubeJS and React</h3><div class="text-muted small"><p> In Part 3 we wrote our ETLs using Python and TDD. In this post we will focus on building an analytics platform for the company using CubeJS. What is CubeJS ? CubeJS is a tool that serves as a bac...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/from-zero-to-data-ready-part-2/" class="btn btn-outline-primary" prompt="Older"><p>From Zero to Data-Ready (Part 2): Building a SQL Data Warehouse</p></a> <a href="/posts/from-zero-to-data-ready-part-4/" class="btn btn-outline-primary" prompt="Newer"><p>From Zero to Data-Ready (Part 4): Building Analytics Dashboards using CubeJS and React</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2024 <a href="https://github.com/sebasgarcep">Sebastian Garrido</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/data-engineering/">Data Engineering</a> <a class="post-tag" href="/tags/from-zero-to-data-ready/">From Zero to Data-Ready</a> <a class="post-tag" href="/tags/retail-project/">Retail Project</a> <a class="post-tag" href="/tags/mathematics/">Mathematics</a> <a class="post-tag" href="/tags/postgres/">Postgres</a> <a class="post-tag" href="/tags/python/">Python</a> <a class="post-tag" href="/tags/rust/">Rust</a> <a class="post-tag" href="/tags/sql/">SQL</a> <a class="post-tag" href="/tags/cubejs/">CubeJS</a> <a class="post-tag" href="/tags/data-assimilation/">Data Assimilation</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script>
