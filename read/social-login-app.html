<!DOCTYPE html><html lang="en"><head>
  <meta charset="UTF-8">
  <link rel="icon" type="image/svg+xml" href="/vite.svg">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vite + React + TS</title>
  <script type="module" crossorigin="" src="/assets/app-BuijL7cK.js"></script>
  <link rel="stylesheet" crossorigin="" href="/assets/app-YlTKHw-j.css">
</head>

<body>
  <div id="root" data-server-rendered="true"><div class="bg-slate-900 flex flex-col min-h-screen max-w-full items-center"><header class="flex flex-row gap-8 justify-center py-4"><a class="flex items-center gap-3 rounded-lg px-3 py-2 transition-all text-gray-300 hover:text-gray-100" href="/posts"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-newspaper h-4 w-4"><path d="M4 22h16a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2H8a2 2 0 0 0-2 2v16a2 2 0 0 1-2 2Zm0 0a2 2 0 0 1-2-2v-9c0-1.1.9-2 2-2h2"></path><path d="M18 14h-8"></path><path d="M15 18h-5"></path><path d="M10 6h8v4h-8V6Z"></path></svg>Posts</a><a class="flex items-center gap-3 rounded-lg px-3 py-2 transition-all text-gray-300 hover:text-gray-100" href="/about"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-user h-4 w-4"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>About</a><a class="flex items-center gap-3 rounded-lg px-3 py-2 transition-all text-gray-300 hover:text-gray-100" href="/tags"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-tag h-4 w-4"><path d="M12.586 2.586A2 2 0 0 0 11.172 2H4a2 2 0 0 0-2 2v7.172a2 2 0 0 0 .586 1.414l8.704 8.704a2.426 2.426 0 0 0 3.42 0l6.58-6.58a2.426 2.426 0 0 0 0-3.42z"></path><circle cx="7.5" cy="7.5" r=".5" fill="currentColor"></circle></svg>Tags</a></header><main class="max-w-sm md:max-w-2xl text-justify"><div class="px-6"><div class="text-2xl font-bold" style="color:lab(80.574 30.6 -11.24)">Writing a React Native App using Expo and Google Social Login</div><h2 class="text-gray-300 text-xs">January 3, 2022</h2><div class="PostBody text-gray-300 mt-2"><p>This will be a brief tutorial on how to write a React Native application, using Expo, that implements Social Authentication, using Google. We will use ExpressJS and Passport in the backend to manage the authentication process. We will assume that the reader is already comfortable with React Native and Express and that they are also proficient with Typescript.</p>
<h1>Designing the Application</h1>
<p>Our client wants a mobile application that allows people to login using any of the major social networks and which feeds authenticated users a random message. Because we will set up everything to be easily extensible we will only implement one of the social authentication providers (Google), as that is enough for an exercise. The application must therefore consist of two screens:</p>
<ul>
<li>Login screen: where the login workflow occurs.</li>
<li>Home screen: where the user can obtain the random message.</li>
</ul>
<p>The backend must implement at least the following two endpoints:</p>
<ul>
<li>POST <code>/api/v1/auth/google</code>: If the login attempt was succesful the mobile device will receive a Google ID token. That token will be sent to this endpoint to trade for a valid session token.</li>
<li>GET <code>/api/v1/message</code>: where authenticated users can obtain a random message.</li>
</ul>
<p>Notice that we do not use the Google ID token as the session token for several reasons. First, it will require us to perform an authentication check on each API call to the Google backend, which will slow down the server response time. Second, Google ID tokens are usually short-lived, so users will be forced to login again after a short amount of time. Third, because we want multiple login providers, trading provider-specific ID tokens for application session tokens simplifies authentication workflows on restricted endpoints.</p>
<h1>Creating the Login Screen</h1>
<p>Start by scaffolding a React Native/Expo App with Typescript. You are going to need to run the following command in order to install the necessary dependencies for social authentication.</p>
<pre><code class="hljs">expo install expo-auth-session expo-web-browser expo-random
</code></pre>
<p>I also like adding React Native Paper for some nice GUI elements, React Navigation for the navigation provider and Redux to use as a global state store.</p>
<p>Once you are ready, create a <code>LoginScreen</code> component as follows:</p>
<pre><code class="hljs"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">StackScreenProps</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@react-navigation/stack'</span>;
<span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">StyleSheet</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'react-native'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Button</span>, <span class="hljs-title class_">Title</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'react-native-paper'</span>;

<span class="hljs-keyword">import</span> <span class="hljs-title class_">Container</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'../components/Container'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">RootStackParamList</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../types'</span>;
<span class="hljs-keyword">import</span> useGoogleLogin <span class="hljs-keyword">from</span> <span class="hljs-string">'../hooks/useGoogleLogin'</span>;
<span class="hljs-keyword">import</span> { useSession } <span class="hljs-keyword">from</span> <span class="hljs-string">'../store/selectors/session'</span>;
 
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">LoginScreen</span>(<span class="hljs-params">{
    navigation,
}: <span class="hljs-title class_">StackScreenProps</span>&lt;<span class="hljs-title class_">RootStackParamList</span>, <span class="hljs-string">'Login'</span>&gt;</span>) {
    <span class="hljs-keyword">const</span> session = <span class="hljs-title function_">useSession</span>();
    <span class="hljs-keyword">const</span> [loadingGoogleLogin, promptGoogleLogin] = <span class="hljs-title function_">useGoogleLogin</span>();

    <span class="hljs-title class_">React</span>.<span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-keyword">if</span> (session) {
            navigation.<span class="hljs-title function_">replace</span>(<span class="hljs-string">'Home'</span>);
        }
    }, [session]);

    <span class="hljs-keyword">return</span> (
        <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Container</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{styles.container}</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">Title</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{styles.title}</span>&gt;</span>Social Login App<span class="hljs-tag">&lt;/<span class="hljs-name">Title</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">Button</span>
                <span class="hljs-attr">disabled</span>=<span class="hljs-string">{loadingGoogleLogin}</span>
                <span class="hljs-attr">icon</span>=<span class="hljs-string">"google"</span>
                <span class="hljs-attr">mode</span>=<span class="hljs-string">"contained"</span>
                <span class="hljs-attr">onPress</span>=<span class="hljs-string">{promptGoogleLogin}</span>
            &gt;</span>
                Login with Google
            <span class="hljs-tag">&lt;/<span class="hljs-name">Button</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">Container</span>&gt;</span></span>
    );
}

<span class="hljs-keyword">const</span> styles = <span class="hljs-title class_">StyleSheet</span>.<span class="hljs-title function_">create</span>({
    <span class="hljs-attr">container</span>: {
        <span class="hljs-attr">padding</span>: <span class="hljs-number">20</span>,
        <span class="hljs-attr">justifyContent</span>: <span class="hljs-string">'center'</span>,
        <span class="hljs-attr">alignItems</span>: <span class="hljs-string">'center'</span>,
    },
    <span class="hljs-attr">title</span>: {
        <span class="hljs-attr">fontSize</span>: <span class="hljs-number">28</span>,
        <span class="hljs-attr">marginBottom</span>: <span class="hljs-number">60</span>,
    },
});
</code></pre>
<p>The important aspects of this screen are:</p>
<ul>
<li><code>useSession</code> hook: trivial state selector that checks that the session exists in the data store and hasn't expired. Returns the session if this holds, otherwise it returns null.</li>
<li><code>useGoogleLogin</code> hook: Handles the Google Login logic on the mobile side. Returns two values to be used by the frontend. <code>loadingGoogleLogin</code> which is a boolean value that tells the frontend whether Google Login is running in the background, and  <code>promptGoogleLogin</code> which triggers the authentication workflow.</li>
<li><code>React.useEffect</code> call: If it observes that the session changes to a non-null value, then it moves the user to the Home screen. Notice that if the application is closed and opened again this piece of code will redirect the user to the Home screen if we persist the data store.</li>
</ul>
<p>Let's dive deeper into the <code>useGoogleLogin</code> implementation:</p>
<pre><code class="hljs"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> <span class="hljs-title class_">Google</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'expo-auth-session/providers/google'</span>;
<span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> <span class="hljs-title class_">WebBrowser</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'expo-web-browser'</span>;
<span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">import</span> { <span class="hljs-variable constant_">GOOGLE_CLIENT_ID</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../constants/environment'</span>;
<span class="hljs-keyword">import</span> { loginWithGoogle } <span class="hljs-keyword">from</span> <span class="hljs-string">'../services/server'</span>;
<span class="hljs-keyword">import</span> { useLogin } <span class="hljs-keyword">from</span> <span class="hljs-string">'../store/actions/session'</span>;

<span class="hljs-title class_">WebBrowser</span>.<span class="hljs-title function_">maybeCompleteAuthSession</span>();

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useGoogleLogin</span>(<span class="hljs-params"></span>): [<span class="hljs-built_in">boolean</span>, <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">any</span>] {
    <span class="hljs-keyword">const</span> login = <span class="hljs-title function_">useLogin</span>();

    <span class="hljs-keyword">const</span> [request, response, promptAsync] = <span class="hljs-title class_">Google</span>.<span class="hljs-title function_">useIdTokenAuthRequest</span>({
        <span class="hljs-attr">clientId</span>: <span class="hljs-variable constant_">GOOGLE_CLIENT_ID</span>,
    });

    <span class="hljs-title class_">React</span>.<span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-keyword">if</span> (response?.<span class="hljs-property">type</span> === <span class="hljs-string">"success"</span>) {
            <span class="hljs-keyword">const</span> { <span class="hljs-attr">id_token</span>: idToken } = response.<span class="hljs-property">params</span>;
            <span class="hljs-title function_">loginWithGoogle</span>(idToken)
                .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">session</span> =&gt;</span> <span class="hljs-title function_">login</span>(session));
        }
    }, [response]);

    <span class="hljs-keyword">const</span> loading = !request;

    <span class="hljs-keyword">const</span> <span class="hljs-title function_">prompt</span> = (<span class="hljs-params"></span>) =&gt; {
        <span class="hljs-title function_">promptAsync</span>();
    };

    <span class="hljs-keyword">return</span> [loading, prompt];
}
</code></pre>
<p>First notice tha usage of <code>WebBrowser.maybeCompleteAuthSession()</code>. This is required in certain environments for the authentication procedure to work. In other environments it is a no-op, so it can be added safely.</p>
<p>First notice the <code>Google.useIdTokenAuthRequest</code> hook. It takes a configuration object as input, with the only required key being the Google Client ID. To obtain a Google Client ID you need to configure a project in GCP and create a OAuth 2.0 Client ID. Further information in how to set up Google Client IDs can be found <a href="https://docs.expo.dev/guides/authentication/#google">here</a>. Notice that each environment (Expo Go, Android Standalone, iOS Standalone) requires a different key. Make sure to set up your application to use different keys for each <a href="https://docs.expo.dev/guides/environment-variables/">environment</a>.</p>
<p>The <code>Google.useIdTokenAuthRequest</code> hook returns three values:</p>
<ul>
<li>the <code>request</code> object if no workflow is in progress, or null otherwise.</li>
<li>the <code>response</code> object after an auth workflow has succeeded or failed.</li>
<li>the <code>promptAsync</code> function that triggers the auth workflow.</li>
</ul>
<p>We need to track the request to determine whether a workflow is in progress. We also have to track the response object to trigger the login action if the workflow succeeds. Finally, we need to return the prompt function to allow consumers of <code>useGoogleLogin</code> to trigger the authentication procedure.</p>
<p>Once we have a response with a <code>success</code> type, we know we have obtained a Google ID token. Now we can use the <code>loginWithGoogle</code> function to trade it for a valid session token. Once we have a session we have to update the global data store with it. The <code>useLogin</code> hook returns a <code>login</code> function that takes a session as input and updates the global data store using said value.</p>
<p>With all of this we have a working Login screen. Now let's proceed to the server-side implementation.</p>
<h1>Configuring Passport for Google Auth</h1>
<p>First let's set up a Node Project with Typescript enabled. Once we have that we can install the following dependencies:</p>
<pre><code class="hljs">yarn add debug express morgan cookie-parser passport passport-google-id-token jsonwebtoken passport-jwt
</code></pre>
<p>We also need to add the following dependencies with the dev flag on so that our typescript compiler will work properly.</p>
<pre><code class="hljs">yarn add -D @types/cookie-parser @types/debug @types/express @types/morgan @types/node @types/passport @types/passport-jwt
</code></pre>
<p>Sadly, the <code>passport-google-id-token</code> has no official Typescript bindings at the time of this writing. I had to write my own and put it in the <code>index.d.ts</code> file at the root of the project. What I ended up using was:</p>
<pre><code class="hljs"><span class="hljs-keyword">declare</span> <span class="hljs-variable language_">module</span> <span class="hljs-string">"passport-google-id-token"</span> {
    <span class="hljs-keyword">import</span> { <span class="hljs-title class_">Strategy</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"passport"</span>;
    
    <span class="hljs-keyword">type</span> <span class="hljs-title class_">GoogleTokenStrategyOptions</span> = {
        <span class="hljs-attr">clientID</span>?: <span class="hljs-built_in">string</span>,
    };

    <span class="hljs-keyword">type</span> <span class="hljs-title class_">DoneFunction</span> = <span class="hljs-function">(<span class="hljs-params"><span class="hljs-attr">err</span>: <span class="hljs-title class_">Error</span> | <span class="hljs-literal">null</span>, <span class="hljs-attr">user</span>?: <span class="hljs-built_in">any</span></span>) =&gt;</span> <span class="hljs-built_in">any</span>;

    <span class="hljs-keyword">type</span> <span class="hljs-title class_">GoogleTokenStrategyCallback</span> = <span class="hljs-function">(<span class="hljs-params"><span class="hljs-attr">parsedToken</span>: <span class="hljs-built_in">any</span>, <span class="hljs-attr">googleId</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">done</span>: <span class="hljs-title class_">DoneFunction</span></span>) =&gt;</span> <span class="hljs-built_in">any</span>;

    <span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GoogleTokenStrategy</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Strategy</span> {
        <span class="hljs-title function_">constructor</span>(<span class="hljs-params"><span class="hljs-attr">options</span>: <span class="hljs-title class_">GoogleTokenStrategyOptions</span>, <span class="hljs-attr">callback</span>: <span class="hljs-title class_">GoogleTokenStrategyCallback</span></span>);
    }
}
</code></pre>
<p>I've also added Prisma to serve as an ORM, Postgres to act as the database and Axios to perform API calls to external services, but you can add whichever services you prefer.</p>
<p>Now, let's start by writing a function in <code>src/app/middleware.ts</code> that adds useful middleware to the Express Application:</p>
<pre><code class="hljs"><span class="hljs-keyword">import</span> cookieParser <span class="hljs-keyword">from</span> <span class="hljs-string">'cookie-parser'</span>;
<span class="hljs-keyword">import</span> express, { <span class="hljs-title class_">Express</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"express"</span>;
<span class="hljs-keyword">import</span> logger <span class="hljs-keyword">from</span> <span class="hljs-string">'morgan'</span>;
<span class="hljs-keyword">import</span> path <span class="hljs-keyword">from</span> <span class="hljs-string">'path'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span>(<span class="hljs-params"><span class="hljs-attr">app</span>: <span class="hljs-title class_">Express</span></span>) {
    app.<span class="hljs-title function_">use</span>(<span class="hljs-title function_">logger</span>(<span class="hljs-string">'dev'</span>));
    app.<span class="hljs-title function_">use</span>(express.<span class="hljs-title function_">json</span>());
    app.<span class="hljs-title function_">use</span>(express.<span class="hljs-title function_">urlencoded</span>({ <span class="hljs-attr">extended</span>: <span class="hljs-literal">false</span> }));
    app.<span class="hljs-title function_">use</span>(<span class="hljs-title function_">cookieParser</span>());
    app.<span class="hljs-title function_">use</span>(express.<span class="hljs-title function_">static</span>(path.<span class="hljs-title function_">join</span>(__dirname, <span class="hljs-string">'public'</span>)));
}
</code></pre>
<p>Now we have to configure Passport. Consider the following function in the file <code>src/app/passport.ts</code>:</p>
<pre><code class="hljs"><span class="hljs-keyword">import</span> createDebug <span class="hljs-keyword">from</span> <span class="hljs-string">'debug'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Express</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'express'</span>;
<span class="hljs-keyword">import</span> passport, { <span class="hljs-title class_">Strategy</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'passport'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">GoogleTokenStrategy</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'passport-google-id-token'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Strategy</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">JWTStrategy</span>, <span class="hljs-title class_">ExtractJwt</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'passport-jwt'</span>;

<span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> <span class="hljs-title class_">User</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'../controllers/user'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Session</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../types'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-variable constant_">GOOGLE_CLIENT_ID</span>, <span class="hljs-variable constant_">JWT_SECRET</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../values'</span>;

<span class="hljs-keyword">const</span> debug = <span class="hljs-title function_">createDebug</span>(<span class="hljs-string">'social-login-server:app:passport'</span>);

<span class="hljs-keyword">function</span> <span class="hljs-title function_">getGoogleTokenStrategy</span>(<span class="hljs-params"><span class="hljs-attr">clientID</span>: <span class="hljs-title class_">String</span></span>): <span class="hljs-title class_">Strategy</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">GoogleTokenStrategy</span>({
        clientID,
    }, <span class="hljs-function">(<span class="hljs-params">parsedToken, googleId, done</span>) =&gt;</span> {
        <span class="hljs-title function_">debug</span>(<span class="hljs-string">`Parsed Token: &lt;span class="katex"&gt;&lt;span class="katex-html" aria-hidden="true"&gt;&lt;span class="base"&gt;&lt;span class="strut" style="height:1em;vertical-align:-0.25em;"&gt;&lt;/span&gt;&lt;span class="mord"&gt;&lt;span class="mord mathnormal" style="margin-right:0.09618em;"&gt;J&lt;/span&gt;&lt;span class="mord mathnormal" style="margin-right:0.10903em;"&gt;SON&lt;/span&gt;&lt;span class="mord"&gt;.&lt;/span&gt;&lt;span class="mord mathnormal"&gt;s&lt;/span&gt;&lt;span class="mord mathnormal"&gt;t&lt;/span&gt;&lt;span class="mord mathnormal" style="margin-right:0.02778em;"&gt;r&lt;/span&gt;&lt;span class="mord mathnormal"&gt;in&lt;/span&gt;&lt;span class="mord mathnormal" style="margin-right:0.03588em;"&gt;g&lt;/span&gt;&lt;span class="mord mathnormal"&gt;i&lt;/span&gt;&lt;span class="mord mathnormal" style="margin-right:0.10764em;"&gt;f&lt;/span&gt;&lt;span class="mord mathnormal" style="margin-right:0.03588em;"&gt;y&lt;/span&gt;&lt;span class="mopen"&gt;(&lt;/span&gt;&lt;span class="mord mathnormal"&gt;p&lt;/span&gt;&lt;span class="mord mathnormal"&gt;a&lt;/span&gt;&lt;span class="mord mathnormal"&gt;rse&lt;/span&gt;&lt;span class="mord mathnormal"&gt;d&lt;/span&gt;&lt;span class="mord mathnormal" style="margin-right:0.13889em;"&gt;T&lt;/span&gt;&lt;span class="mord mathnormal"&gt;o&lt;/span&gt;&lt;span class="mord mathnormal" style="margin-right:0.03148em;"&gt;k&lt;/span&gt;&lt;span class="mord mathnormal"&gt;e&lt;/span&gt;&lt;span class="mord mathnormal"&gt;n&lt;/span&gt;&lt;span class="mpunct"&gt;,&lt;/span&gt;&lt;span class="mspace" style="margin-right:0.1667em;"&gt;&lt;/span&gt;&lt;span class="mord mathnormal"&gt;n&lt;/span&gt;&lt;span class="mord mathnormal"&gt;u&lt;/span&gt;&lt;span class="mord mathnormal" style="margin-right:0.01968em;"&gt;ll&lt;/span&gt;&lt;span class="mpunct"&gt;,&lt;/span&gt;&lt;span class="mspace" style="margin-right:0.1667em;"&gt;&lt;/span&gt;&lt;span class="mord"&gt;4&lt;/span&gt;&lt;span class="mclose"&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class="mord"&gt;‘&lt;/span&gt;&lt;span class="mclose"&gt;)&lt;/span&gt;&lt;span class="mpunct"&gt;;&lt;/span&gt;&lt;span class="mspace" style="margin-right:0.1667em;"&gt;&lt;/span&gt;&lt;span class="mord mathnormal"&gt;d&lt;/span&gt;&lt;span class="mord mathnormal"&gt;e&lt;/span&gt;&lt;span class="mord mathnormal"&gt;b&lt;/span&gt;&lt;span class="mord mathnormal" style="margin-right:0.03588em;"&gt;ug&lt;/span&gt;&lt;span class="mopen"&gt;(&lt;/span&gt;&lt;span class="mord"&gt;‘&lt;/span&gt;&lt;span class="mord mathnormal"&gt;G&lt;/span&gt;&lt;span class="mord mathnormal"&gt;oo&lt;/span&gt;&lt;span class="mord mathnormal" style="margin-right:0.03588em;"&gt;g&lt;/span&gt;&lt;span class="mord mathnormal" style="margin-right:0.01968em;"&gt;l&lt;/span&gt;&lt;span class="mord mathnormal"&gt;e&lt;/span&gt;&lt;span class="mord mathnormal" style="margin-right:0.07847em;"&gt;I&lt;/span&gt;&lt;span class="mord mathnormal" style="margin-right:0.02778em;"&gt;D&lt;/span&gt;&lt;span class="mspace" style="margin-right:0.2778em;"&gt;&lt;/span&gt;&lt;span class="mrel"&gt;:&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;{googleId}`</span>);
        <span class="hljs-title class_">User</span>.<span class="hljs-title function_">getOrCreateUserByGoogleId</span>(googleId)
            .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">user</span> =&gt;</span> <span class="hljs-title function_">done</span>(<span class="hljs-literal">null</span>, user))
            .<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> <span class="hljs-title function_">done</span>(err));
    });
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">getJWTStrategy</span>(<span class="hljs-params"></span>): <span class="hljs-title class_">Strategy</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JWTStrategy</span>({
        <span class="hljs-attr">jwtFromRequest</span>: <span class="hljs-title class_">ExtractJwt</span>.<span class="hljs-title function_">fromAuthHeaderAsBearerToken</span>(),
        <span class="hljs-attr">secretOrKey</span>: <span class="hljs-variable constant_">JWT_SECRET</span>,
    }, <span class="hljs-function">(<span class="hljs-params"><span class="hljs-attr">payload</span>: <span class="hljs-title class_">Session</span>, done</span>) =&gt;</span> {
        <span class="hljs-title function_">debug</span>(<span class="hljs-string">`JWT Payload: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(payload, <span class="hljs-literal">null</span>, <span class="hljs-number">4</span>)}</span>`</span>);

        <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() &gt;= payload.<span class="hljs-property">expiresAt</span>) {
            <span class="hljs-title function_">done</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>());
            <span class="hljs-keyword">return</span>;
        }

        <span class="hljs-title function_">done</span>(<span class="hljs-literal">null</span>, payload);
    });
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span>(<span class="hljs-params"><span class="hljs-attr">app</span>: <span class="hljs-title class_">Express</span></span>) {
    app.<span class="hljs-title function_">use</span>(passport.<span class="hljs-title function_">initialize</span>());

    passport.<span class="hljs-title function_">serializeUser</span>(<span class="hljs-function">(<span class="hljs-params">user, done</span>) =&gt;</span> {
        <span class="hljs-title function_">done</span>(<span class="hljs-literal">null</span>, user);
    });

    passport.<span class="hljs-title function_">use</span>(<span class="hljs-string">'google-id-token'</span>, <span class="hljs-title function_">getGoogleTokenStrategy</span>(<span class="hljs-variable constant_">GOOGLE_CLIENT_ID</span>));
    passport.<span class="hljs-title function_">use</span>(<span class="hljs-string">'jwt'</span>, <span class="hljs-title function_">getJWTStrategy</span>());
}
</code></pre>
<p>First we have to initialize passport with the call <code>app.use(passport.initialize())</code>. After that we have to add a <code>serializeUser</code> function to passport. Whenever we login, it transforms the incoming login credentials into a session. We won't need to do anything here as we will be using the Authentication header, and not cookies. Therefore an identity function will suffice. Finally, we add two strategies to passport:</p>
<ul>
<li><code>GoogleTokenStrategy</code>: Extracts the Google ID token from the body of the request. Specifically, it looks for the <code>id_token</code> key in the body.</li>
<li><code>JWTStrategy</code>: Parses the session token into a JSON session object using the secret key. We have configured it to extract the session token from the Authentication header using <code>ExtractJwt.fromAuthHeaderAsBearerToken()</code>.</li>
</ul>
<p>These strategies will add whatever we return using the verify callback to the <code>req.user</code> property of the request. Now let's add the routes to the app in <code>src/app/routes.ts</code>:</p>
<pre><code class="hljs"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Express</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'express'</span>;

<span class="hljs-keyword">import</span> authRouter <span class="hljs-keyword">from</span> <span class="hljs-string">'../routes/auth'</span>;
<span class="hljs-keyword">import</span> messageRouter <span class="hljs-keyword">from</span> <span class="hljs-string">'../routes/message'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span>(<span class="hljs-params"><span class="hljs-attr">app</span>: <span class="hljs-title class_">Express</span></span>) {
    app.<span class="hljs-title function_">use</span>(<span class="hljs-string">'/api/v1/auth'</span>, authRouter);
    app.<span class="hljs-title function_">use</span>(<span class="hljs-string">'/api/v1/message'</span>, messageRouter);
}
</code></pre>
<p>The authentication router has the following implementation:</p>
<pre><code class="hljs"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">User</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@prisma/client'</span>;
<span class="hljs-keyword">import</span> express <span class="hljs-keyword">from</span> <span class="hljs-string">'express'</span>;
<span class="hljs-keyword">import</span> jwt <span class="hljs-keyword">from</span> <span class="hljs-string">'jsonwebtoken'</span>;
<span class="hljs-keyword">import</span> passport <span class="hljs-keyword">from</span> <span class="hljs-string">'passport'</span>;

<span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> <span class="hljs-title class_">Session</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'../controllers/session'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-variable constant_">JWT_SECRET</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../values'</span>;

<span class="hljs-keyword">const</span> router = express.<span class="hljs-title class_">Router</span>();

router.<span class="hljs-title function_">post</span>(<span class="hljs-string">'/google'</span>, passport.<span class="hljs-title function_">authenticate</span>(<span class="hljs-string">'google-id-token'</span>), <span class="hljs-title function_">async</span> (req, res) =&gt; {
    <span class="hljs-keyword">const</span> session = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Session</span>.<span class="hljs-title function_">getSessionByUser</span>(req.<span class="hljs-property">user</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">User</span>);
    <span class="hljs-keyword">const</span> credentials = jwt.<span class="hljs-title function_">sign</span>(session, <span class="hljs-variable constant_">JWT_SECRET</span>);
    res.<span class="hljs-title function_">json</span>({
        <span class="hljs-attr">data</span>: {
            <span class="hljs-attr">scheme</span>: <span class="hljs-string">'Bearer'</span>,
            credentials,
            <span class="hljs-attr">expiresAt</span>: session.<span class="hljs-property">expiresAt</span>,
        },
    });
});

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> router;
</code></pre>
<p>Notice that between the path and the callback we add a <code>passport.authenticate</code> call to tell the application to enforce the <code>google-id-token</code> authentication method for this endpoint. Simple as that. If the Google ID token is valid, the callback will run, otherwise it will return a 401 error code.</p>
<p>With that done, we build a session object and convert it into a valid JSON Web Token. The consumer of this endpoint will want to know the scheme used in the Authentication header (Bearer in this case), the session token (which we send in the credentials property), and when the session expires to improve the user experience.</p>
<p>There is a small caveat to add at this point. Notice that for each of the three possible environments we have mentioned we are going to need different Google Client IDs. But we have used a single one up until now. To work around this issue we can create one authentication strategy for each environment:</p>
<pre><code class="hljs">passport.<span class="hljs-title function_">use</span>(<span class="hljs-string">'google-id-token-&lt;env&gt;'</span>, <span class="hljs-title function_">getGoogleTokenStrategy</span>(<span class="hljs-variable constant_">GOOGLE_CLIENT_ID_</span>&lt;<span class="hljs-variable constant_">ENV</span>&gt;));
</code></pre>
<p>And create one endpoint for each environment using each of these strategies.</p>
<p>Now let's move to the message router:</p>
<pre><code class="hljs"><span class="hljs-keyword">import</span> express <span class="hljs-keyword">from</span> <span class="hljs-string">'express'</span>;
<span class="hljs-keyword">import</span> passport <span class="hljs-keyword">from</span> <span class="hljs-string">'passport'</span>;

<span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> <span class="hljs-title class_">Message</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'../controllers/message'</span>;

<span class="hljs-keyword">const</span> router = express.<span class="hljs-title class_">Router</span>();

router.<span class="hljs-title function_">use</span>(passport.<span class="hljs-title function_">authenticate</span>(<span class="hljs-string">'jwt'</span>, { <span class="hljs-attr">session</span>: <span class="hljs-literal">false</span> }));

router.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/'</span>, <span class="hljs-title function_">async</span> (req, res) =&gt; {
    <span class="hljs-keyword">const</span> message = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Message</span>.<span class="hljs-title function_">getRandomMessage</span>();
    res.<span class="hljs-title function_">json</span>({
        <span class="hljs-attr">data</span>: { message },
    });
});

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> router;
</code></pre>
<p>Because we expect all endpoints to be secured for this part of the application, we enforce JWT authentication at router level with the line:</p>
<pre><code class="hljs">router.<span class="hljs-title function_">use</span>(passport.<span class="hljs-title function_">authenticate</span>(<span class="hljs-string">'jwt'</span>, { <span class="hljs-attr">session</span>: <span class="hljs-literal">false</span> }));
</code></pre>
<p>Everything after that is business logic.</p>
<h1>Results</h1>
<p>At this point we have a working Login Screen that allows logging in using Google.</p>
<img src="/assets/img/2022-01-03-social-login-app/screenshot_login.jpg" alt="Login Screen" width="200">
<p>Moreover, we have a Home Screen that shows authenticated users a random message from the server.</p>
<img src="/assets/img/2022-01-03-social-login-app/screenshot_home.jpg" alt="Home Screen" width="200">
<p>At which point we are done with the tutorial.</p>
<h1>Sources</h1>
<ul>
<li><a href="https://github.com/sebasgarcep/social-login-app">React Native Application</a></li>
<li><a href="https://github.com/sebasgarcep/social-login-server">Express Application</a></li>
</ul>
</div><div class="my-8"><div class="flex flex-row items-start gap-2 w-full flex-wrap"><div class="text-gray-300 border bg-muted/10 px-4 py-2 rounded-2xl hover:bg-muted/50 transition-all whitespace-nowrap"><a href="/tags/Software%20Engineering">Software Engineering</a></div><div class="text-gray-300 border bg-muted/10 px-4 py-2 rounded-2xl hover:bg-muted/50 transition-all whitespace-nowrap"><a href="/tags/React%20Native">React Native</a></div><div class="text-gray-300 border bg-muted/10 px-4 py-2 rounded-2xl hover:bg-muted/50 transition-all whitespace-nowrap"><a href="/tags/Expo">Expo</a></div><div class="text-gray-300 border bg-muted/10 px-4 py-2 rounded-2xl hover:bg-muted/50 transition-all whitespace-nowrap"><a href="/tags/Social%20Login">Social Login</a></div><div class="text-gray-300 border bg-muted/10 px-4 py-2 rounded-2xl hover:bg-muted/50 transition-all whitespace-nowrap"><a href="/tags/Express">Express</a></div><div class="text-gray-300 border bg-muted/10 px-4 py-2 rounded-2xl hover:bg-muted/50 transition-all whitespace-nowrap"><a href="/tags/Passport">Passport</a></div><div class="text-gray-300 border bg-muted/10 px-4 py-2 rounded-2xl hover:bg-muted/50 transition-all whitespace-nowrap"><a href="/tags/Google">Google</a></div></div></div><div class="flex flex-row mb-8"><a class="border flex-1 transition-all p-4 hover:bg-muted/20 rounded-l-sm" href="/read/counting-primes-really-fast"><div class="text-gray-400 text-sm">Previous</div><div class="text-gray-100">Counting Primes Really Fast</div></a><a class="border flex-1 transition-all p-4 hover:bg-muted/20 rounded-r-sm" href="/read/kalman-filter-tutorial"><div class="text-gray-400 text-sm">Next</div><div class="text-gray-100">Understanding the Kalman Filter</div></a></div></div></main></div><script>window.__staticRouterHydrationData = JSON.parse("{\"loaderData\":{\"0\":null,\"0-2\":{\"post\":{\"title\":\"Writing a React Native App using Expo and Google Social Login\",\"date\":1641168000000,\"text\":\"\u003cp\u003eThis will be a brief tutorial on how to write a React Native application, using Expo, that implements Social Authentication, using Google. We will use ExpressJS and Passport in the backend to manage the authentication process. We will assume that the reader is already comfortable with React Native and Express and that they are also proficient with Typescript.\u003c/p\u003e\\n\u003ch1\u003eDesigning the Application\u003c/h1\u003e\\n\u003cp\u003eOur client wants a mobile application that allows people to login using any of the major social networks and which feeds authenticated users a random message. Because we will set up everything to be easily extensible we will only implement one of the social authentication providers (Google), as that is enough for an exercise. The application must therefore consist of two screens:\u003c/p\u003e\\n\u003cul\u003e\\n\u003cli\u003eLogin screen: where the login workflow occurs.\u003c/li\u003e\\n\u003cli\u003eHome screen: where the user can obtain the random message.\u003c/li\u003e\\n\u003c/ul\u003e\\n\u003cp\u003eThe backend must implement at least the following two endpoints:\u003c/p\u003e\\n\u003cul\u003e\\n\u003cli\u003ePOST \u003ccode\u003e/api/v1/auth/google\u003c/code\u003e: If the login attempt was succesful the mobile device will receive a Google ID token. That token will be sent to this endpoint to trade for a valid session token.\u003c/li\u003e\\n\u003cli\u003eGET \u003ccode\u003e/api/v1/message\u003c/code\u003e: where authenticated users can obtain a random message.\u003c/li\u003e\\n\u003c/ul\u003e\\n\u003cp\u003eNotice that we do not use the Google ID token as the session token for several reasons. First, it will require us to perform an authentication check on each API call to the Google backend, which will slow down the server response time. Second, Google ID tokens are usually short-lived, so users will be forced to login again after a short amount of time. Third, because we want multiple login providers, trading provider-specific ID tokens for application session tokens simplifies authentication workflows on restricted endpoints.\u003c/p\u003e\\n\u003ch1\u003eCreating the Login Screen\u003c/h1\u003e\\n\u003cp\u003eStart by scaffolding a React Native/Expo App with Typescript. You are going to need to run the following command in order to install the necessary dependencies for social authentication.\u003c/p\u003e\\n\u003cpre\u003e\u003ccode class=\\\"hljs\\\"\u003eexpo install expo-auth-session expo-web-browser expo-random\\n\u003c/code\u003e\u003c/pre\u003e\\n\u003cp\u003eI also like adding React Native Paper for some nice GUI elements, React Navigation for the navigation provider and Redux to use as a global state store.\u003c/p\u003e\\n\u003cp\u003eOnce you are ready, create a \u003ccode\u003eLoginScreen\u003c/code\u003e component as follows:\u003c/p\u003e\\n\u003cpre\u003e\u003ccode class=\\\"hljs\\\"\u003e\u003cspan class=\\\"hljs-keyword\\\"\u003eimport\u003c/span\u003e { \u003cspan class=\\\"hljs-title class_\\\"\u003eStackScreenProps\u003c/span\u003e } \u003cspan class=\\\"hljs-keyword\\\"\u003efrom\u003c/span\u003e \u003cspan class=\\\"hljs-string\\\"\u003e\u0026#x27;@react-navigation/stack\u0026#x27;\u003c/span\u003e;\\n\u003cspan class=\\\"hljs-keyword\\\"\u003eimport\u003c/span\u003e * \u003cspan class=\\\"hljs-keyword\\\"\u003eas\u003c/span\u003e \u003cspan class=\\\"hljs-title class_\\\"\u003eReact\u003c/span\u003e \u003cspan class=\\\"hljs-keyword\\\"\u003efrom\u003c/span\u003e \u003cspan class=\\\"hljs-string\\\"\u003e\u0026#x27;react\u0026#x27;\u003c/span\u003e;\\n\u003cspan class=\\\"hljs-keyword\\\"\u003eimport\u003c/span\u003e { \u003cspan class=\\\"hljs-title class_\\\"\u003eStyleSheet\u003c/span\u003e } \u003cspan class=\\\"hljs-keyword\\\"\u003efrom\u003c/span\u003e \u003cspan class=\\\"hljs-string\\\"\u003e\u0026#x27;react-native\u0026#x27;\u003c/span\u003e;\\n\u003cspan class=\\\"hljs-keyword\\\"\u003eimport\u003c/span\u003e { \u003cspan class=\\\"hljs-title class_\\\"\u003eButton\u003c/span\u003e, \u003cspan class=\\\"hljs-title class_\\\"\u003eTitle\u003c/span\u003e } \u003cspan class=\\\"hljs-keyword\\\"\u003efrom\u003c/span\u003e \u003cspan class=\\\"hljs-string\\\"\u003e\u0026#x27;react-native-paper\u0026#x27;\u003c/span\u003e;\\n\\n\u003cspan class=\\\"hljs-keyword\\\"\u003eimport\u003c/span\u003e \u003cspan class=\\\"hljs-title class_\\\"\u003eContainer\u003c/span\u003e \u003cspan class=\\\"hljs-keyword\\\"\u003efrom\u003c/span\u003e \u003cspan class=\\\"hljs-string\\\"\u003e\u0026#x27;../components/Container\u0026#x27;\u003c/span\u003e;\\n\u003cspan class=\\\"hljs-keyword\\\"\u003eimport\u003c/span\u003e { \u003cspan class=\\\"hljs-title class_\\\"\u003eRootStackParamList\u003c/span\u003e } \u003cspan class=\\\"hljs-keyword\\\"\u003efrom\u003c/span\u003e \u003cspan class=\\\"hljs-string\\\"\u003e\u0026#x27;../types\u0026#x27;\u003c/span\u003e;\\n\u003cspan class=\\\"hljs-keyword\\\"\u003eimport\u003c/span\u003e useGoogleLogin \u003cspan class=\\\"hljs-keyword\\\"\u003efrom\u003c/span\u003e \u003cspan class=\\\"hljs-string\\\"\u003e\u0026#x27;../hooks/useGoogleLogin\u0026#x27;\u003c/span\u003e;\\n\u003cspan class=\\\"hljs-keyword\\\"\u003eimport\u003c/span\u003e { useSession } \u003cspan class=\\\"hljs-keyword\\\"\u003efrom\u003c/span\u003e \u003cspan class=\\\"hljs-string\\\"\u003e\u0026#x27;../store/selectors/session\u0026#x27;\u003c/span\u003e;\\n \\n\u003cspan class=\\\"hljs-keyword\\\"\u003eexport\u003c/span\u003e \u003cspan class=\\\"hljs-keyword\\\"\u003edefault\u003c/span\u003e \u003cspan class=\\\"hljs-keyword\\\"\u003efunction\u003c/span\u003e \u003cspan class=\\\"hljs-title function_\\\"\u003eLoginScreen\u003c/span\u003e(\u003cspan class=\\\"hljs-params\\\"\u003e{\\n    navigation,\\n}: \u003cspan class=\\\"hljs-title class_\\\"\u003eStackScreenProps\u003c/span\u003e\u0026lt;\u003cspan class=\\\"hljs-title class_\\\"\u003eRootStackParamList\u003c/span\u003e, \u003cspan class=\\\"hljs-string\\\"\u003e\u0026#x27;Login\u0026#x27;\u003c/span\u003e\u0026gt;\u003c/span\u003e) {\\n    \u003cspan class=\\\"hljs-keyword\\\"\u003econst\u003c/span\u003e session = \u003cspan class=\\\"hljs-title function_\\\"\u003euseSession\u003c/span\u003e();\\n    \u003cspan class=\\\"hljs-keyword\\\"\u003econst\u003c/span\u003e [loadingGoogleLogin, promptGoogleLogin] = \u003cspan class=\\\"hljs-title function_\\\"\u003euseGoogleLogin\u003c/span\u003e();\\n\\n    \u003cspan class=\\\"hljs-title class_\\\"\u003eReact\u003c/span\u003e.\u003cspan class=\\\"hljs-title function_\\\"\u003euseEffect\u003c/span\u003e(\u003cspan class=\\\"hljs-function\\\"\u003e() =\u0026gt;\u003c/span\u003e {\\n        \u003cspan class=\\\"hljs-keyword\\\"\u003eif\u003c/span\u003e (session) {\\n            navigation.\u003cspan class=\\\"hljs-title function_\\\"\u003ereplace\u003c/span\u003e(\u003cspan class=\\\"hljs-string\\\"\u003e\u0026#x27;Home\u0026#x27;\u003c/span\u003e);\\n        }\\n    }, [session]);\\n\\n    \u003cspan class=\\\"hljs-keyword\\\"\u003ereturn\u003c/span\u003e (\\n        \u003cspan class=\\\"language-xml\\\"\u003e\u003cspan class=\\\"hljs-tag\\\"\u003e\u0026lt;\u003cspan class=\\\"hljs-name\\\"\u003eContainer\u003c/span\u003e \u003cspan class=\\\"hljs-attr\\\"\u003estyle\u003c/span\u003e=\u003cspan class=\\\"hljs-string\\\"\u003e{styles.container}\u003c/span\u003e\u0026gt;\u003c/span\u003e\\n            \u003cspan class=\\\"hljs-tag\\\"\u003e\u0026lt;\u003cspan class=\\\"hljs-name\\\"\u003eTitle\u003c/span\u003e \u003cspan class=\\\"hljs-attr\\\"\u003estyle\u003c/span\u003e=\u003cspan class=\\\"hljs-string\\\"\u003e{styles.title}\u003c/span\u003e\u0026gt;\u003c/span\u003eSocial Login App\u003cspan class=\\\"hljs-tag\\\"\u003e\u0026lt;/\u003cspan class=\\\"hljs-name\\\"\u003eTitle\u003c/span\u003e\u0026gt;\u003c/span\u003e\\n            \u003cspan class=\\\"hljs-tag\\\"\u003e\u0026lt;\u003cspan class=\\\"hljs-name\\\"\u003eButton\u003c/span\u003e\\n                \u003cspan class=\\\"hljs-attr\\\"\u003edisabled\u003c/span\u003e=\u003cspan class=\\\"hljs-string\\\"\u003e{loadingGoogleLogin}\u003c/span\u003e\\n                \u003cspan class=\\\"hljs-attr\\\"\u003eicon\u003c/span\u003e=\u003cspan class=\\\"hljs-string\\\"\u003e\u0026quot;google\u0026quot;\u003c/span\u003e\\n                \u003cspan class=\\\"hljs-attr\\\"\u003emode\u003c/span\u003e=\u003cspan class=\\\"hljs-string\\\"\u003e\u0026quot;contained\u0026quot;\u003c/span\u003e\\n                \u003cspan class=\\\"hljs-attr\\\"\u003eonPress\u003c/span\u003e=\u003cspan class=\\\"hljs-string\\\"\u003e{promptGoogleLogin}\u003c/span\u003e\\n            \u0026gt;\u003c/span\u003e\\n                Login with Google\\n            \u003cspan class=\\\"hljs-tag\\\"\u003e\u0026lt;/\u003cspan class=\\\"hljs-name\\\"\u003eButton\u003c/span\u003e\u0026gt;\u003c/span\u003e\\n        \u003cspan class=\\\"hljs-tag\\\"\u003e\u0026lt;/\u003cspan class=\\\"hljs-name\\\"\u003eContainer\u003c/span\u003e\u0026gt;\u003c/span\u003e\u003c/span\u003e\\n    );\\n}\\n\\n\u003cspan class=\\\"hljs-keyword\\\"\u003econst\u003c/span\u003e styles = \u003cspan class=\\\"hljs-title class_\\\"\u003eStyleSheet\u003c/span\u003e.\u003cspan class=\\\"hljs-title function_\\\"\u003ecreate\u003c/span\u003e({\\n    \u003cspan class=\\\"hljs-attr\\\"\u003econtainer\u003c/span\u003e: {\\n        \u003cspan class=\\\"hljs-attr\\\"\u003epadding\u003c/span\u003e: \u003cspan class=\\\"hljs-number\\\"\u003e20\u003c/span\u003e,\\n        \u003cspan class=\\\"hljs-attr\\\"\u003ejustifyContent\u003c/span\u003e: \u003cspan class=\\\"hljs-string\\\"\u003e\u0026#x27;center\u0026#x27;\u003c/span\u003e,\\n        \u003cspan class=\\\"hljs-attr\\\"\u003ealignItems\u003c/span\u003e: \u003cspan class=\\\"hljs-string\\\"\u003e\u0026#x27;center\u0026#x27;\u003c/span\u003e,\\n    },\\n    \u003cspan class=\\\"hljs-attr\\\"\u003etitle\u003c/span\u003e: {\\n        \u003cspan class=\\\"hljs-attr\\\"\u003efontSize\u003c/span\u003e: \u003cspan class=\\\"hljs-number\\\"\u003e28\u003c/span\u003e,\\n        \u003cspan class=\\\"hljs-attr\\\"\u003emarginBottom\u003c/span\u003e: \u003cspan class=\\\"hljs-number\\\"\u003e60\u003c/span\u003e,\\n    },\\n});\\n\u003c/code\u003e\u003c/pre\u003e\\n\u003cp\u003eThe important aspects of this screen are:\u003c/p\u003e\\n\u003cul\u003e\\n\u003cli\u003e\u003ccode\u003euseSession\u003c/code\u003e hook: trivial state selector that checks that the session exists in the data store and hasn't expired. Returns the session if this holds, otherwise it returns null.\u003c/li\u003e\\n\u003cli\u003e\u003ccode\u003euseGoogleLogin\u003c/code\u003e hook: Handles the Google Login logic on the mobile side. Returns two values to be used by the frontend. \u003ccode\u003eloadingGoogleLogin\u003c/code\u003e which is a boolean value that tells the frontend whether Google Login is running in the background, and  \u003ccode\u003epromptGoogleLogin\u003c/code\u003e which triggers the authentication workflow.\u003c/li\u003e\\n\u003cli\u003e\u003ccode\u003eReact.useEffect\u003c/code\u003e call: If it observes that the session changes to a non-null value, then it moves the user to the Home screen. Notice that if the application is closed and opened again this piece of code will redirect the user to the Home screen if we persist the data store.\u003c/li\u003e\\n\u003c/ul\u003e\\n\u003cp\u003eLet's dive deeper into the \u003ccode\u003euseGoogleLogin\u003c/code\u003e implementation:\u003c/p\u003e\\n\u003cpre\u003e\u003ccode class=\\\"hljs\\\"\u003e\u003cspan class=\\\"hljs-keyword\\\"\u003eimport\u003c/span\u003e * \u003cspan class=\\\"hljs-keyword\\\"\u003eas\u003c/span\u003e \u003cspan class=\\\"hljs-title class_\\\"\u003eGoogle\u003c/span\u003e \u003cspan class=\\\"hljs-keyword\\\"\u003efrom\u003c/span\u003e \u003cspan class=\\\"hljs-string\\\"\u003e\u0026#x27;expo-auth-session/providers/google\u0026#x27;\u003c/span\u003e;\\n\u003cspan class=\\\"hljs-keyword\\\"\u003eimport\u003c/span\u003e * \u003cspan class=\\\"hljs-keyword\\\"\u003eas\u003c/span\u003e \u003cspan class=\\\"hljs-title class_\\\"\u003eWebBrowser\u003c/span\u003e \u003cspan class=\\\"hljs-keyword\\\"\u003efrom\u003c/span\u003e \u003cspan class=\\\"hljs-string\\\"\u003e\u0026#x27;expo-web-browser\u0026#x27;\u003c/span\u003e;\\n\u003cspan class=\\\"hljs-keyword\\\"\u003eimport\u003c/span\u003e * \u003cspan class=\\\"hljs-keyword\\\"\u003eas\u003c/span\u003e \u003cspan class=\\\"hljs-title class_\\\"\u003eReact\u003c/span\u003e \u003cspan class=\\\"hljs-keyword\\\"\u003efrom\u003c/span\u003e \u003cspan class=\\\"hljs-string\\\"\u003e\u0026#x27;react\u0026#x27;\u003c/span\u003e;\\n\\n\u003cspan class=\\\"hljs-keyword\\\"\u003eimport\u003c/span\u003e { \u003cspan class=\\\"hljs-variable constant_\\\"\u003eGOOGLE_CLIENT_ID\u003c/span\u003e } \u003cspan class=\\\"hljs-keyword\\\"\u003efrom\u003c/span\u003e \u003cspan class=\\\"hljs-string\\\"\u003e\u0026#x27;../constants/environment\u0026#x27;\u003c/span\u003e;\\n\u003cspan class=\\\"hljs-keyword\\\"\u003eimport\u003c/span\u003e { loginWithGoogle } \u003cspan class=\\\"hljs-keyword\\\"\u003efrom\u003c/span\u003e \u003cspan class=\\\"hljs-string\\\"\u003e\u0026#x27;../services/server\u0026#x27;\u003c/span\u003e;\\n\u003cspan class=\\\"hljs-keyword\\\"\u003eimport\u003c/span\u003e { useLogin } \u003cspan class=\\\"hljs-keyword\\\"\u003efrom\u003c/span\u003e \u003cspan class=\\\"hljs-string\\\"\u003e\u0026#x27;../store/actions/session\u0026#x27;\u003c/span\u003e;\\n\\n\u003cspan class=\\\"hljs-title class_\\\"\u003eWebBrowser\u003c/span\u003e.\u003cspan class=\\\"hljs-title function_\\\"\u003emaybeCompleteAuthSession\u003c/span\u003e();\\n\\n\u003cspan class=\\\"hljs-keyword\\\"\u003eexport\u003c/span\u003e \u003cspan class=\\\"hljs-keyword\\\"\u003edefault\u003c/span\u003e \u003cspan class=\\\"hljs-keyword\\\"\u003efunction\u003c/span\u003e \u003cspan class=\\\"hljs-title function_\\\"\u003euseGoogleLogin\u003c/span\u003e(\u003cspan class=\\\"hljs-params\\\"\u003e\u003c/span\u003e): [\u003cspan class=\\\"hljs-built_in\\\"\u003eboolean\u003c/span\u003e, \u003cspan class=\\\"hljs-function\\\"\u003e() =\u0026gt;\u003c/span\u003e \u003cspan class=\\\"hljs-built_in\\\"\u003eany\u003c/span\u003e] {\\n    \u003cspan class=\\\"hljs-keyword\\\"\u003econst\u003c/span\u003e login = \u003cspan class=\\\"hljs-title function_\\\"\u003euseLogin\u003c/span\u003e();\\n\\n    \u003cspan class=\\\"hljs-keyword\\\"\u003econst\u003c/span\u003e [request, response, promptAsync] = \u003cspan class=\\\"hljs-title class_\\\"\u003eGoogle\u003c/span\u003e.\u003cspan class=\\\"hljs-title function_\\\"\u003euseIdTokenAuthRequest\u003c/span\u003e({\\n        \u003cspan class=\\\"hljs-attr\\\"\u003eclientId\u003c/span\u003e: \u003cspan class=\\\"hljs-variable constant_\\\"\u003eGOOGLE_CLIENT_ID\u003c/span\u003e,\\n    });\\n\\n    \u003cspan class=\\\"hljs-title class_\\\"\u003eReact\u003c/span\u003e.\u003cspan class=\\\"hljs-title function_\\\"\u003euseEffect\u003c/span\u003e(\u003cspan class=\\\"hljs-function\\\"\u003e() =\u0026gt;\u003c/span\u003e {\\n        \u003cspan class=\\\"hljs-keyword\\\"\u003eif\u003c/span\u003e (response?.\u003cspan class=\\\"hljs-property\\\"\u003etype\u003c/span\u003e === \u003cspan class=\\\"hljs-string\\\"\u003e\u0026quot;success\u0026quot;\u003c/span\u003e) {\\n            \u003cspan class=\\\"hljs-keyword\\\"\u003econst\u003c/span\u003e { \u003cspan class=\\\"hljs-attr\\\"\u003eid_token\u003c/span\u003e: idToken } = response.\u003cspan class=\\\"hljs-property\\\"\u003eparams\u003c/span\u003e;\\n            \u003cspan class=\\\"hljs-title function_\\\"\u003eloginWithGoogle\u003c/span\u003e(idToken)\\n                .\u003cspan class=\\\"hljs-title function_\\\"\u003ethen\u003c/span\u003e(\u003cspan class=\\\"hljs-function\\\"\u003e\u003cspan class=\\\"hljs-params\\\"\u003esession\u003c/span\u003e =\u0026gt;\u003c/span\u003e \u003cspan class=\\\"hljs-title function_\\\"\u003elogin\u003c/span\u003e(session));\\n        }\\n    }, [response]);\\n\\n    \u003cspan class=\\\"hljs-keyword\\\"\u003econst\u003c/span\u003e loading = !request;\\n\\n    \u003cspan class=\\\"hljs-keyword\\\"\u003econst\u003c/span\u003e \u003cspan class=\\\"hljs-title function_\\\"\u003eprompt\u003c/span\u003e = (\u003cspan class=\\\"hljs-params\\\"\u003e\u003c/span\u003e) =\u0026gt; {\\n        \u003cspan class=\\\"hljs-title function_\\\"\u003epromptAsync\u003c/span\u003e();\\n    };\\n\\n    \u003cspan class=\\\"hljs-keyword\\\"\u003ereturn\u003c/span\u003e [loading, prompt];\\n}\\n\u003c/code\u003e\u003c/pre\u003e\\n\u003cp\u003eFirst notice tha usage of \u003ccode\u003eWebBrowser.maybeCompleteAuthSession()\u003c/code\u003e. This is required in certain environments for the authentication procedure to work. In other environments it is a no-op, so it can be added safely.\u003c/p\u003e\\n\u003cp\u003eFirst notice the \u003ccode\u003eGoogle.useIdTokenAuthRequest\u003c/code\u003e hook. It takes a configuration object as input, with the only required key being the Google Client ID. To obtain a Google Client ID you need to configure a project in GCP and create a OAuth 2.0 Client ID. Further information in how to set up Google Client IDs can be found \u003ca href=\\\"https://docs.expo.dev/guides/authentication/#google\\\"\u003ehere\u003c/a\u003e. Notice that each environment (Expo Go, Android Standalone, iOS Standalone) requires a different key. Make sure to set up your application to use different keys for each \u003ca href=\\\"https://docs.expo.dev/guides/environment-variables/\\\"\u003eenvironment\u003c/a\u003e.\u003c/p\u003e\\n\u003cp\u003eThe \u003ccode\u003eGoogle.useIdTokenAuthRequest\u003c/code\u003e hook returns three values:\u003c/p\u003e\\n\u003cul\u003e\\n\u003cli\u003ethe \u003ccode\u003erequest\u003c/code\u003e object if no workflow is in progress, or null otherwise.\u003c/li\u003e\\n\u003cli\u003ethe \u003ccode\u003eresponse\u003c/code\u003e object after an auth workflow has succeeded or failed.\u003c/li\u003e\\n\u003cli\u003ethe \u003ccode\u003epromptAsync\u003c/code\u003e function that triggers the auth workflow.\u003c/li\u003e\\n\u003c/ul\u003e\\n\u003cp\u003eWe need to track the request to determine whether a workflow is in progress. We also have to track the response object to trigger the login action if the workflow succeeds. Finally, we need to return the prompt function to allow consumers of \u003ccode\u003euseGoogleLogin\u003c/code\u003e to trigger the authentication procedure.\u003c/p\u003e\\n\u003cp\u003eOnce we have a response with a \u003ccode\u003esuccess\u003c/code\u003e type, we know we have obtained a Google ID token. Now we can use the \u003ccode\u003eloginWithGoogle\u003c/code\u003e function to trade it for a valid session token. Once we have a session we have to update the global data store with it. The \u003ccode\u003euseLogin\u003c/code\u003e hook returns a \u003ccode\u003elogin\u003c/code\u003e function that takes a session as input and updates the global data store using said value.\u003c/p\u003e\\n\u003cp\u003eWith all of this we have a working Login screen. Now let's proceed to the server-side implementation.\u003c/p\u003e\\n\u003ch1\u003eConfiguring Passport for Google Auth\u003c/h1\u003e\\n\u003cp\u003eFirst let's set up a Node Project with Typescript enabled. Once we have that we can install the following dependencies:\u003c/p\u003e\\n\u003cpre\u003e\u003ccode class=\\\"hljs\\\"\u003eyarn add debug express morgan cookie-parser passport passport-google-id-token jsonwebtoken passport-jwt\\n\u003c/code\u003e\u003c/pre\u003e\\n\u003cp\u003eWe also need to add the following dependencies with the dev flag on so that our typescript compiler will work properly.\u003c/p\u003e\\n\u003cpre\u003e\u003ccode class=\\\"hljs\\\"\u003eyarn add -D @types/cookie-parser @types/debug @types/express @types/morgan @types/node @types/passport @types/passport-jwt\\n\u003c/code\u003e\u003c/pre\u003e\\n\u003cp\u003eSadly, the \u003ccode\u003epassport-google-id-token\u003c/code\u003e has no official Typescript bindings at the time of this writing. I had to write my own and put it in the \u003ccode\u003eindex.d.ts\u003c/code\u003e file at the root of the project. What I ended up using was:\u003c/p\u003e\\n\u003cpre\u003e\u003ccode class=\\\"hljs\\\"\u003e\u003cspan class=\\\"hljs-keyword\\\"\u003edeclare\u003c/span\u003e \u003cspan class=\\\"hljs-variable language_\\\"\u003emodule\u003c/span\u003e \u003cspan class=\\\"hljs-string\\\"\u003e\u0026quot;passport-google-id-token\u0026quot;\u003c/span\u003e {\\n    \u003cspan class=\\\"hljs-keyword\\\"\u003eimport\u003c/span\u003e { \u003cspan class=\\\"hljs-title class_\\\"\u003eStrategy\u003c/span\u003e } \u003cspan class=\\\"hljs-keyword\\\"\u003efrom\u003c/span\u003e \u003cspan class=\\\"hljs-string\\\"\u003e\u0026quot;passport\u0026quot;\u003c/span\u003e;\\n    \\n    \u003cspan class=\\\"hljs-keyword\\\"\u003etype\u003c/span\u003e \u003cspan class=\\\"hljs-title class_\\\"\u003eGoogleTokenStrategyOptions\u003c/span\u003e = {\\n        \u003cspan class=\\\"hljs-attr\\\"\u003eclientID\u003c/span\u003e?: \u003cspan class=\\\"hljs-built_in\\\"\u003estring\u003c/span\u003e,\\n    };\\n\\n    \u003cspan class=\\\"hljs-keyword\\\"\u003etype\u003c/span\u003e \u003cspan class=\\\"hljs-title class_\\\"\u003eDoneFunction\u003c/span\u003e = \u003cspan class=\\\"hljs-function\\\"\u003e(\u003cspan class=\\\"hljs-params\\\"\u003e\u003cspan class=\\\"hljs-attr\\\"\u003eerr\u003c/span\u003e: \u003cspan class=\\\"hljs-title class_\\\"\u003eError\u003c/span\u003e | \u003cspan class=\\\"hljs-literal\\\"\u003enull\u003c/span\u003e, \u003cspan class=\\\"hljs-attr\\\"\u003euser\u003c/span\u003e?: \u003cspan class=\\\"hljs-built_in\\\"\u003eany\u003c/span\u003e\u003c/span\u003e) =\u0026gt;\u003c/span\u003e \u003cspan class=\\\"hljs-built_in\\\"\u003eany\u003c/span\u003e;\\n\\n    \u003cspan class=\\\"hljs-keyword\\\"\u003etype\u003c/span\u003e \u003cspan class=\\\"hljs-title class_\\\"\u003eGoogleTokenStrategyCallback\u003c/span\u003e = \u003cspan class=\\\"hljs-function\\\"\u003e(\u003cspan class=\\\"hljs-params\\\"\u003e\u003cspan class=\\\"hljs-attr\\\"\u003eparsedToken\u003c/span\u003e: \u003cspan class=\\\"hljs-built_in\\\"\u003eany\u003c/span\u003e, \u003cspan class=\\\"hljs-attr\\\"\u003egoogleId\u003c/span\u003e: \u003cspan class=\\\"hljs-built_in\\\"\u003estring\u003c/span\u003e, \u003cspan class=\\\"hljs-attr\\\"\u003edone\u003c/span\u003e: \u003cspan class=\\\"hljs-title class_\\\"\u003eDoneFunction\u003c/span\u003e\u003c/span\u003e) =\u0026gt;\u003c/span\u003e \u003cspan class=\\\"hljs-built_in\\\"\u003eany\u003c/span\u003e;\\n\\n    \u003cspan class=\\\"hljs-keyword\\\"\u003eexport\u003c/span\u003e \u003cspan class=\\\"hljs-keyword\\\"\u003edefault\u003c/span\u003e \u003cspan class=\\\"hljs-keyword\\\"\u003eclass\u003c/span\u003e \u003cspan class=\\\"hljs-title class_\\\"\u003eGoogleTokenStrategy\u003c/span\u003e \u003cspan class=\\\"hljs-keyword\\\"\u003eextends\u003c/span\u003e \u003cspan class=\\\"hljs-title class_ inherited__\\\"\u003eStrategy\u003c/span\u003e {\\n        \u003cspan class=\\\"hljs-title function_\\\"\u003econstructor\u003c/span\u003e(\u003cspan class=\\\"hljs-params\\\"\u003e\u003cspan class=\\\"hljs-attr\\\"\u003eoptions\u003c/span\u003e: \u003cspan class=\\\"hljs-title class_\\\"\u003eGoogleTokenStrategyOptions\u003c/span\u003e, \u003cspan class=\\\"hljs-attr\\\"\u003ecallback\u003c/span\u003e: \u003cspan class=\\\"hljs-title class_\\\"\u003eGoogleTokenStrategyCallback\u003c/span\u003e\u003c/span\u003e);\\n    }\\n}\\n\u003c/code\u003e\u003c/pre\u003e\\n\u003cp\u003eI've also added Prisma to serve as an ORM, Postgres to act as the database and Axios to perform API calls to external services, but you can add whichever services you prefer.\u003c/p\u003e\\n\u003cp\u003eNow, let's start by writing a function in \u003ccode\u003esrc/app/middleware.ts\u003c/code\u003e that adds useful middleware to the Express Application:\u003c/p\u003e\\n\u003cpre\u003e\u003ccode class=\\\"hljs\\\"\u003e\u003cspan class=\\\"hljs-keyword\\\"\u003eimport\u003c/span\u003e cookieParser \u003cspan class=\\\"hljs-keyword\\\"\u003efrom\u003c/span\u003e \u003cspan class=\\\"hljs-string\\\"\u003e\u0026#x27;cookie-parser\u0026#x27;\u003c/span\u003e;\\n\u003cspan class=\\\"hljs-keyword\\\"\u003eimport\u003c/span\u003e express, { \u003cspan class=\\\"hljs-title class_\\\"\u003eExpress\u003c/span\u003e } \u003cspan class=\\\"hljs-keyword\\\"\u003efrom\u003c/span\u003e \u003cspan class=\\\"hljs-string\\\"\u003e\u0026quot;express\u0026quot;\u003c/span\u003e;\\n\u003cspan class=\\\"hljs-keyword\\\"\u003eimport\u003c/span\u003e logger \u003cspan class=\\\"hljs-keyword\\\"\u003efrom\u003c/span\u003e \u003cspan class=\\\"hljs-string\\\"\u003e\u0026#x27;morgan\u0026#x27;\u003c/span\u003e;\\n\u003cspan class=\\\"hljs-keyword\\\"\u003eimport\u003c/span\u003e path \u003cspan class=\\\"hljs-keyword\\\"\u003efrom\u003c/span\u003e \u003cspan class=\\\"hljs-string\\\"\u003e\u0026#x27;path\u0026#x27;\u003c/span\u003e;\\n\\n\u003cspan class=\\\"hljs-keyword\\\"\u003eexport\u003c/span\u003e \u003cspan class=\\\"hljs-keyword\\\"\u003edefault\u003c/span\u003e \u003cspan class=\\\"hljs-keyword\\\"\u003efunction\u003c/span\u003e(\u003cspan class=\\\"hljs-params\\\"\u003e\u003cspan class=\\\"hljs-attr\\\"\u003eapp\u003c/span\u003e: \u003cspan class=\\\"hljs-title class_\\\"\u003eExpress\u003c/span\u003e\u003c/span\u003e) {\\n    app.\u003cspan class=\\\"hljs-title function_\\\"\u003euse\u003c/span\u003e(\u003cspan class=\\\"hljs-title function_\\\"\u003elogger\u003c/span\u003e(\u003cspan class=\\\"hljs-string\\\"\u003e\u0026#x27;dev\u0026#x27;\u003c/span\u003e));\\n    app.\u003cspan class=\\\"hljs-title function_\\\"\u003euse\u003c/span\u003e(express.\u003cspan class=\\\"hljs-title function_\\\"\u003ejson\u003c/span\u003e());\\n    app.\u003cspan class=\\\"hljs-title function_\\\"\u003euse\u003c/span\u003e(express.\u003cspan class=\\\"hljs-title function_\\\"\u003eurlencoded\u003c/span\u003e({ \u003cspan class=\\\"hljs-attr\\\"\u003eextended\u003c/span\u003e: \u003cspan class=\\\"hljs-literal\\\"\u003efalse\u003c/span\u003e }));\\n    app.\u003cspan class=\\\"hljs-title function_\\\"\u003euse\u003c/span\u003e(\u003cspan class=\\\"hljs-title function_\\\"\u003ecookieParser\u003c/span\u003e());\\n    app.\u003cspan class=\\\"hljs-title function_\\\"\u003euse\u003c/span\u003e(express.\u003cspan class=\\\"hljs-title function_\\\"\u003estatic\u003c/span\u003e(path.\u003cspan class=\\\"hljs-title function_\\\"\u003ejoin\u003c/span\u003e(__dirname, \u003cspan class=\\\"hljs-string\\\"\u003e\u0026#x27;public\u0026#x27;\u003c/span\u003e)));\\n}\\n\u003c/code\u003e\u003c/pre\u003e\\n\u003cp\u003eNow we have to configure Passport. Consider the following function in the file \u003ccode\u003esrc/app/passport.ts\u003c/code\u003e:\u003c/p\u003e\\n\u003cpre\u003e\u003ccode class=\\\"hljs\\\"\u003e\u003cspan class=\\\"hljs-keyword\\\"\u003eimport\u003c/span\u003e createDebug \u003cspan class=\\\"hljs-keyword\\\"\u003efrom\u003c/span\u003e \u003cspan class=\\\"hljs-string\\\"\u003e\u0026#x27;debug\u0026#x27;\u003c/span\u003e;\\n\u003cspan class=\\\"hljs-keyword\\\"\u003eimport\u003c/span\u003e { \u003cspan class=\\\"hljs-title class_\\\"\u003eExpress\u003c/span\u003e } \u003cspan class=\\\"hljs-keyword\\\"\u003efrom\u003c/span\u003e \u003cspan class=\\\"hljs-string\\\"\u003e\u0026#x27;express\u0026#x27;\u003c/span\u003e;\\n\u003cspan class=\\\"hljs-keyword\\\"\u003eimport\u003c/span\u003e passport, { \u003cspan class=\\\"hljs-title class_\\\"\u003eStrategy\u003c/span\u003e } \u003cspan class=\\\"hljs-keyword\\\"\u003efrom\u003c/span\u003e \u003cspan class=\\\"hljs-string\\\"\u003e\u0026#x27;passport\u0026#x27;\u003c/span\u003e;\\n\u003cspan class=\\\"hljs-keyword\\\"\u003eimport\u003c/span\u003e \u003cspan class=\\\"hljs-title class_\\\"\u003eGoogleTokenStrategy\u003c/span\u003e \u003cspan class=\\\"hljs-keyword\\\"\u003efrom\u003c/span\u003e \u003cspan class=\\\"hljs-string\\\"\u003e\u0026#x27;passport-google-id-token\u0026#x27;\u003c/span\u003e;\\n\u003cspan class=\\\"hljs-keyword\\\"\u003eimport\u003c/span\u003e { \u003cspan class=\\\"hljs-title class_\\\"\u003eStrategy\u003c/span\u003e \u003cspan class=\\\"hljs-keyword\\\"\u003eas\u003c/span\u003e \u003cspan class=\\\"hljs-title class_\\\"\u003eJWTStrategy\u003c/span\u003e, \u003cspan class=\\\"hljs-title class_\\\"\u003eExtractJwt\u003c/span\u003e } \u003cspan class=\\\"hljs-keyword\\\"\u003efrom\u003c/span\u003e \u003cspan class=\\\"hljs-string\\\"\u003e\u0026#x27;passport-jwt\u0026#x27;\u003c/span\u003e;\\n\\n\u003cspan class=\\\"hljs-keyword\\\"\u003eimport\u003c/span\u003e * \u003cspan class=\\\"hljs-keyword\\\"\u003eas\u003c/span\u003e \u003cspan class=\\\"hljs-title class_\\\"\u003eUser\u003c/span\u003e \u003cspan class=\\\"hljs-keyword\\\"\u003efrom\u003c/span\u003e \u003cspan class=\\\"hljs-string\\\"\u003e\u0026#x27;../controllers/user\u0026#x27;\u003c/span\u003e;\\n\u003cspan class=\\\"hljs-keyword\\\"\u003eimport\u003c/span\u003e { \u003cspan class=\\\"hljs-title class_\\\"\u003eSession\u003c/span\u003e } \u003cspan class=\\\"hljs-keyword\\\"\u003efrom\u003c/span\u003e \u003cspan class=\\\"hljs-string\\\"\u003e\u0026#x27;../types\u0026#x27;\u003c/span\u003e;\\n\u003cspan class=\\\"hljs-keyword\\\"\u003eimport\u003c/span\u003e { \u003cspan class=\\\"hljs-variable constant_\\\"\u003eGOOGLE_CLIENT_ID\u003c/span\u003e, \u003cspan class=\\\"hljs-variable constant_\\\"\u003eJWT_SECRET\u003c/span\u003e } \u003cspan class=\\\"hljs-keyword\\\"\u003efrom\u003c/span\u003e \u003cspan class=\\\"hljs-string\\\"\u003e\u0026#x27;../values\u0026#x27;\u003c/span\u003e;\\n\\n\u003cspan class=\\\"hljs-keyword\\\"\u003econst\u003c/span\u003e debug = \u003cspan class=\\\"hljs-title function_\\\"\u003ecreateDebug\u003c/span\u003e(\u003cspan class=\\\"hljs-string\\\"\u003e\u0026#x27;social-login-server:app:passport\u0026#x27;\u003c/span\u003e);\\n\\n\u003cspan class=\\\"hljs-keyword\\\"\u003efunction\u003c/span\u003e \u003cspan class=\\\"hljs-title function_\\\"\u003egetGoogleTokenStrategy\u003c/span\u003e(\u003cspan class=\\\"hljs-params\\\"\u003e\u003cspan class=\\\"hljs-attr\\\"\u003eclientID\u003c/span\u003e: \u003cspan class=\\\"hljs-title class_\\\"\u003eString\u003c/span\u003e\u003c/span\u003e): \u003cspan class=\\\"hljs-title class_\\\"\u003eStrategy\u003c/span\u003e {\\n    \u003cspan class=\\\"hljs-keyword\\\"\u003ereturn\u003c/span\u003e \u003cspan class=\\\"hljs-keyword\\\"\u003enew\u003c/span\u003e \u003cspan class=\\\"hljs-title class_\\\"\u003eGoogleTokenStrategy\u003c/span\u003e({\\n        clientID,\\n    }, \u003cspan class=\\\"hljs-function\\\"\u003e(\u003cspan class=\\\"hljs-params\\\"\u003eparsedToken, googleId, done\u003c/span\u003e) =\u0026gt;\u003c/span\u003e {\\n        \u003cspan class=\\\"hljs-title function_\\\"\u003edebug\u003c/span\u003e(\u003cspan class=\\\"hljs-string\\\"\u003e`Parsed Token: \u0026lt;span class=\u0026quot;katex\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;katex-html\u0026quot; aria-hidden=\u0026quot;true\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;base\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;strut\u0026quot; style=\u0026quot;height:1em;vertical-align:-0.25em;\u0026quot;\u0026gt;\u0026lt;/span\u0026gt;\u0026lt;span class=\u0026quot;mord\u0026quot;\u0026gt;\u0026lt;span class=\u0026quot;mord mathnormal\u0026quot; style=\u0026quot;margin-right:0.09618em;\u0026quot;\u0026gt;J\u0026lt;/span\u0026gt;\u0026lt;span class=\u0026quot;mord mathnormal\u0026quot; style=\u0026quot;margin-right:0.10903em;\u0026quot;\u0026gt;SON\u0026lt;/span\u0026gt;\u0026lt;span class=\u0026quot;mord\u0026quot;\u0026gt;.\u0026lt;/span\u0026gt;\u0026lt;span class=\u0026quot;mord mathnormal\u0026quot;\u0026gt;s\u0026lt;/span\u0026gt;\u0026lt;span class=\u0026quot;mord mathnormal\u0026quot;\u0026gt;t\u0026lt;/span\u0026gt;\u0026lt;span class=\u0026quot;mord mathnormal\u0026quot; style=\u0026quot;margin-right:0.02778em;\u0026quot;\u0026gt;r\u0026lt;/span\u0026gt;\u0026lt;span class=\u0026quot;mord mathnormal\u0026quot;\u0026gt;in\u0026lt;/span\u0026gt;\u0026lt;span class=\u0026quot;mord mathnormal\u0026quot; style=\u0026quot;margin-right:0.03588em;\u0026quot;\u0026gt;g\u0026lt;/span\u0026gt;\u0026lt;span class=\u0026quot;mord mathnormal\u0026quot;\u0026gt;i\u0026lt;/span\u0026gt;\u0026lt;span class=\u0026quot;mord mathnormal\u0026quot; style=\u0026quot;margin-right:0.10764em;\u0026quot;\u0026gt;f\u0026lt;/span\u0026gt;\u0026lt;span class=\u0026quot;mord mathnormal\u0026quot; style=\u0026quot;margin-right:0.03588em;\u0026quot;\u0026gt;y\u0026lt;/span\u0026gt;\u0026lt;span class=\u0026quot;mopen\u0026quot;\u0026gt;(\u0026lt;/span\u0026gt;\u0026lt;span class=\u0026quot;mord mathnormal\u0026quot;\u0026gt;p\u0026lt;/span\u0026gt;\u0026lt;span class=\u0026quot;mord mathnormal\u0026quot;\u0026gt;a\u0026lt;/span\u0026gt;\u0026lt;span class=\u0026quot;mord mathnormal\u0026quot;\u0026gt;rse\u0026lt;/span\u0026gt;\u0026lt;span class=\u0026quot;mord mathnormal\u0026quot;\u0026gt;d\u0026lt;/span\u0026gt;\u0026lt;span class=\u0026quot;mord mathnormal\u0026quot; style=\u0026quot;margin-right:0.13889em;\u0026quot;\u0026gt;T\u0026lt;/span\u0026gt;\u0026lt;span class=\u0026quot;mord mathnormal\u0026quot;\u0026gt;o\u0026lt;/span\u0026gt;\u0026lt;span class=\u0026quot;mord mathnormal\u0026quot; style=\u0026quot;margin-right:0.03148em;\u0026quot;\u0026gt;k\u0026lt;/span\u0026gt;\u0026lt;span class=\u0026quot;mord mathnormal\u0026quot;\u0026gt;e\u0026lt;/span\u0026gt;\u0026lt;span class=\u0026quot;mord mathnormal\u0026quot;\u0026gt;n\u0026lt;/span\u0026gt;\u0026lt;span class=\u0026quot;mpunct\u0026quot;\u0026gt;,\u0026lt;/span\u0026gt;\u0026lt;span class=\u0026quot;mspace\u0026quot; style=\u0026quot;margin-right:0.1667em;\u0026quot;\u0026gt;\u0026lt;/span\u0026gt;\u0026lt;span class=\u0026quot;mord mathnormal\u0026quot;\u0026gt;n\u0026lt;/span\u0026gt;\u0026lt;span class=\u0026quot;mord mathnormal\u0026quot;\u0026gt;u\u0026lt;/span\u0026gt;\u0026lt;span class=\u0026quot;mord mathnormal\u0026quot; style=\u0026quot;margin-right:0.01968em;\u0026quot;\u0026gt;ll\u0026lt;/span\u0026gt;\u0026lt;span class=\u0026quot;mpunct\u0026quot;\u0026gt;,\u0026lt;/span\u0026gt;\u0026lt;span class=\u0026quot;mspace\u0026quot; style=\u0026quot;margin-right:0.1667em;\u0026quot;\u0026gt;\u0026lt;/span\u0026gt;\u0026lt;span class=\u0026quot;mord\u0026quot;\u0026gt;4\u0026lt;/span\u0026gt;\u0026lt;span class=\u0026quot;mclose\u0026quot;\u0026gt;)\u0026lt;/span\u0026gt;\u0026lt;/span\u0026gt;\u0026lt;span class=\u0026quot;mord\u0026quot;\u0026gt;‘\u0026lt;/span\u0026gt;\u0026lt;span class=\u0026quot;mclose\u0026quot;\u0026gt;)\u0026lt;/span\u0026gt;\u0026lt;span class=\u0026quot;mpunct\u0026quot;\u0026gt;;\u0026lt;/span\u0026gt;\u0026lt;span class=\u0026quot;mspace\u0026quot; style=\u0026quot;margin-right:0.1667em;\u0026quot;\u0026gt;\u0026lt;/span\u0026gt;\u0026lt;span class=\u0026quot;mord mathnormal\u0026quot;\u0026gt;d\u0026lt;/span\u0026gt;\u0026lt;span class=\u0026quot;mord mathnormal\u0026quot;\u0026gt;e\u0026lt;/span\u0026gt;\u0026lt;span class=\u0026quot;mord mathnormal\u0026quot;\u0026gt;b\u0026lt;/span\u0026gt;\u0026lt;span class=\u0026quot;mord mathnormal\u0026quot; style=\u0026quot;margin-right:0.03588em;\u0026quot;\u0026gt;ug\u0026lt;/span\u0026gt;\u0026lt;span class=\u0026quot;mopen\u0026quot;\u0026gt;(\u0026lt;/span\u0026gt;\u0026lt;span class=\u0026quot;mord\u0026quot;\u0026gt;‘\u0026lt;/span\u0026gt;\u0026lt;span class=\u0026quot;mord mathnormal\u0026quot;\u0026gt;G\u0026lt;/span\u0026gt;\u0026lt;span class=\u0026quot;mord mathnormal\u0026quot;\u0026gt;oo\u0026lt;/span\u0026gt;\u0026lt;span class=\u0026quot;mord mathnormal\u0026quot; style=\u0026quot;margin-right:0.03588em;\u0026quot;\u0026gt;g\u0026lt;/span\u0026gt;\u0026lt;span class=\u0026quot;mord mathnormal\u0026quot; style=\u0026quot;margin-right:0.01968em;\u0026quot;\u0026gt;l\u0026lt;/span\u0026gt;\u0026lt;span class=\u0026quot;mord mathnormal\u0026quot;\u0026gt;e\u0026lt;/span\u0026gt;\u0026lt;span class=\u0026quot;mord mathnormal\u0026quot; style=\u0026quot;margin-right:0.07847em;\u0026quot;\u0026gt;I\u0026lt;/span\u0026gt;\u0026lt;span class=\u0026quot;mord mathnormal\u0026quot; style=\u0026quot;margin-right:0.02778em;\u0026quot;\u0026gt;D\u0026lt;/span\u0026gt;\u0026lt;span class=\u0026quot;mspace\u0026quot; style=\u0026quot;margin-right:0.2778em;\u0026quot;\u0026gt;\u0026lt;/span\u0026gt;\u0026lt;span class=\u0026quot;mrel\u0026quot;\u0026gt;:\u0026lt;/span\u0026gt;\u0026lt;/span\u0026gt;\u0026lt;/span\u0026gt;\u0026lt;/span\u0026gt;{googleId}`\u003c/span\u003e);\\n        \u003cspan class=\\\"hljs-title class_\\\"\u003eUser\u003c/span\u003e.\u003cspan class=\\\"hljs-title function_\\\"\u003egetOrCreateUserByGoogleId\u003c/span\u003e(googleId)\\n            .\u003cspan class=\\\"hljs-title function_\\\"\u003ethen\u003c/span\u003e(\u003cspan class=\\\"hljs-function\\\"\u003e\u003cspan class=\\\"hljs-params\\\"\u003euser\u003c/span\u003e =\u0026gt;\u003c/span\u003e \u003cspan class=\\\"hljs-title function_\\\"\u003edone\u003c/span\u003e(\u003cspan class=\\\"hljs-literal\\\"\u003enull\u003c/span\u003e, user))\\n            .\u003cspan class=\\\"hljs-title function_\\\"\u003ecatch\u003c/span\u003e(\u003cspan class=\\\"hljs-function\\\"\u003e\u003cspan class=\\\"hljs-params\\\"\u003eerr\u003c/span\u003e =\u0026gt;\u003c/span\u003e \u003cspan class=\\\"hljs-title function_\\\"\u003edone\u003c/span\u003e(err));\\n    });\\n}\\n\\n\u003cspan class=\\\"hljs-keyword\\\"\u003efunction\u003c/span\u003e \u003cspan class=\\\"hljs-title function_\\\"\u003egetJWTStrategy\u003c/span\u003e(\u003cspan class=\\\"hljs-params\\\"\u003e\u003c/span\u003e): \u003cspan class=\\\"hljs-title class_\\\"\u003eStrategy\u003c/span\u003e {\\n    \u003cspan class=\\\"hljs-keyword\\\"\u003ereturn\u003c/span\u003e \u003cspan class=\\\"hljs-keyword\\\"\u003enew\u003c/span\u003e \u003cspan class=\\\"hljs-title class_\\\"\u003eJWTStrategy\u003c/span\u003e({\\n        \u003cspan class=\\\"hljs-attr\\\"\u003ejwtFromRequest\u003c/span\u003e: \u003cspan class=\\\"hljs-title class_\\\"\u003eExtractJwt\u003c/span\u003e.\u003cspan class=\\\"hljs-title function_\\\"\u003efromAuthHeaderAsBearerToken\u003c/span\u003e(),\\n        \u003cspan class=\\\"hljs-attr\\\"\u003esecretOrKey\u003c/span\u003e: \u003cspan class=\\\"hljs-variable constant_\\\"\u003eJWT_SECRET\u003c/span\u003e,\\n    }, \u003cspan class=\\\"hljs-function\\\"\u003e(\u003cspan class=\\\"hljs-params\\\"\u003e\u003cspan class=\\\"hljs-attr\\\"\u003epayload\u003c/span\u003e: \u003cspan class=\\\"hljs-title class_\\\"\u003eSession\u003c/span\u003e, done\u003c/span\u003e) =\u0026gt;\u003c/span\u003e {\\n        \u003cspan class=\\\"hljs-title function_\\\"\u003edebug\u003c/span\u003e(\u003cspan class=\\\"hljs-string\\\"\u003e`JWT Payload: \u003cspan class=\\\"hljs-subst\\\"\u003e${\u003cspan class=\\\"hljs-built_in\\\"\u003eJSON\u003c/span\u003e.stringify(payload, \u003cspan class=\\\"hljs-literal\\\"\u003enull\u003c/span\u003e, \u003cspan class=\\\"hljs-number\\\"\u003e4\u003c/span\u003e)}\u003c/span\u003e`\u003c/span\u003e);\\n\\n        \u003cspan class=\\\"hljs-keyword\\\"\u003eif\u003c/span\u003e (\u003cspan class=\\\"hljs-title class_\\\"\u003eDate\u003c/span\u003e.\u003cspan class=\\\"hljs-title function_\\\"\u003enow\u003c/span\u003e() \u0026gt;= payload.\u003cspan class=\\\"hljs-property\\\"\u003eexpiresAt\u003c/span\u003e) {\\n            \u003cspan class=\\\"hljs-title function_\\\"\u003edone\u003c/span\u003e(\u003cspan class=\\\"hljs-keyword\\\"\u003enew\u003c/span\u003e \u003cspan class=\\\"hljs-title class_\\\"\u003eError\u003c/span\u003e());\\n            \u003cspan class=\\\"hljs-keyword\\\"\u003ereturn\u003c/span\u003e;\\n        }\\n\\n        \u003cspan class=\\\"hljs-title function_\\\"\u003edone\u003c/span\u003e(\u003cspan class=\\\"hljs-literal\\\"\u003enull\u003c/span\u003e, payload);\\n    });\\n}\\n\\n\u003cspan class=\\\"hljs-keyword\\\"\u003eexport\u003c/span\u003e \u003cspan class=\\\"hljs-keyword\\\"\u003edefault\u003c/span\u003e \u003cspan class=\\\"hljs-keyword\\\"\u003efunction\u003c/span\u003e(\u003cspan class=\\\"hljs-params\\\"\u003e\u003cspan class=\\\"hljs-attr\\\"\u003eapp\u003c/span\u003e: \u003cspan class=\\\"hljs-title class_\\\"\u003eExpress\u003c/span\u003e\u003c/span\u003e) {\\n    app.\u003cspan class=\\\"hljs-title function_\\\"\u003euse\u003c/span\u003e(passport.\u003cspan class=\\\"hljs-title function_\\\"\u003einitialize\u003c/span\u003e());\\n\\n    passport.\u003cspan class=\\\"hljs-title function_\\\"\u003eserializeUser\u003c/span\u003e(\u003cspan class=\\\"hljs-function\\\"\u003e(\u003cspan class=\\\"hljs-params\\\"\u003euser, done\u003c/span\u003e) =\u0026gt;\u003c/span\u003e {\\n        \u003cspan class=\\\"hljs-title function_\\\"\u003edone\u003c/span\u003e(\u003cspan class=\\\"hljs-literal\\\"\u003enull\u003c/span\u003e, user);\\n    });\\n\\n    passport.\u003cspan class=\\\"hljs-title function_\\\"\u003euse\u003c/span\u003e(\u003cspan class=\\\"hljs-string\\\"\u003e\u0026#x27;google-id-token\u0026#x27;\u003c/span\u003e, \u003cspan class=\\\"hljs-title function_\\\"\u003egetGoogleTokenStrategy\u003c/span\u003e(\u003cspan class=\\\"hljs-variable constant_\\\"\u003eGOOGLE_CLIENT_ID\u003c/span\u003e));\\n    passport.\u003cspan class=\\\"hljs-title function_\\\"\u003euse\u003c/span\u003e(\u003cspan class=\\\"hljs-string\\\"\u003e\u0026#x27;jwt\u0026#x27;\u003c/span\u003e, \u003cspan class=\\\"hljs-title function_\\\"\u003egetJWTStrategy\u003c/span\u003e());\\n}\\n\u003c/code\u003e\u003c/pre\u003e\\n\u003cp\u003eFirst we have to initialize passport with the call \u003ccode\u003eapp.use(passport.initialize())\u003c/code\u003e. After that we have to add a \u003ccode\u003eserializeUser\u003c/code\u003e function to passport. Whenever we login, it transforms the incoming login credentials into a session. We won't need to do anything here as we will be using the Authentication header, and not cookies. Therefore an identity function will suffice. Finally, we add two strategies to passport:\u003c/p\u003e\\n\u003cul\u003e\\n\u003cli\u003e\u003ccode\u003eGoogleTokenStrategy\u003c/code\u003e: Extracts the Google ID token from the body of the request. Specifically, it looks for the \u003ccode\u003eid_token\u003c/code\u003e key in the body.\u003c/li\u003e\\n\u003cli\u003e\u003ccode\u003eJWTStrategy\u003c/code\u003e: Parses the session token into a JSON session object using the secret key. We have configured it to extract the session token from the Authentication header using \u003ccode\u003eExtractJwt.fromAuthHeaderAsBearerToken()\u003c/code\u003e.\u003c/li\u003e\\n\u003c/ul\u003e\\n\u003cp\u003eThese strategies will add whatever we return using the verify callback to the \u003ccode\u003ereq.user\u003c/code\u003e property of the request. Now let's add the routes to the app in \u003ccode\u003esrc/app/routes.ts\u003c/code\u003e:\u003c/p\u003e\\n\u003cpre\u003e\u003ccode class=\\\"hljs\\\"\u003e\u003cspan class=\\\"hljs-keyword\\\"\u003eimport\u003c/span\u003e { \u003cspan class=\\\"hljs-title class_\\\"\u003eExpress\u003c/span\u003e } \u003cspan class=\\\"hljs-keyword\\\"\u003efrom\u003c/span\u003e \u003cspan class=\\\"hljs-string\\\"\u003e\u0026#x27;express\u0026#x27;\u003c/span\u003e;\\n\\n\u003cspan class=\\\"hljs-keyword\\\"\u003eimport\u003c/span\u003e authRouter \u003cspan class=\\\"hljs-keyword\\\"\u003efrom\u003c/span\u003e \u003cspan class=\\\"hljs-string\\\"\u003e\u0026#x27;../routes/auth\u0026#x27;\u003c/span\u003e;\\n\u003cspan class=\\\"hljs-keyword\\\"\u003eimport\u003c/span\u003e messageRouter \u003cspan class=\\\"hljs-keyword\\\"\u003efrom\u003c/span\u003e \u003cspan class=\\\"hljs-string\\\"\u003e\u0026#x27;../routes/message\u0026#x27;\u003c/span\u003e;\\n\\n\u003cspan class=\\\"hljs-keyword\\\"\u003eexport\u003c/span\u003e \u003cspan class=\\\"hljs-keyword\\\"\u003edefault\u003c/span\u003e \u003cspan class=\\\"hljs-keyword\\\"\u003efunction\u003c/span\u003e(\u003cspan class=\\\"hljs-params\\\"\u003e\u003cspan class=\\\"hljs-attr\\\"\u003eapp\u003c/span\u003e: \u003cspan class=\\\"hljs-title class_\\\"\u003eExpress\u003c/span\u003e\u003c/span\u003e) {\\n    app.\u003cspan class=\\\"hljs-title function_\\\"\u003euse\u003c/span\u003e(\u003cspan class=\\\"hljs-string\\\"\u003e\u0026#x27;/api/v1/auth\u0026#x27;\u003c/span\u003e, authRouter);\\n    app.\u003cspan class=\\\"hljs-title function_\\\"\u003euse\u003c/span\u003e(\u003cspan class=\\\"hljs-string\\\"\u003e\u0026#x27;/api/v1/message\u0026#x27;\u003c/span\u003e, messageRouter);\\n}\\n\u003c/code\u003e\u003c/pre\u003e\\n\u003cp\u003eThe authentication router has the following implementation:\u003c/p\u003e\\n\u003cpre\u003e\u003ccode class=\\\"hljs\\\"\u003e\u003cspan class=\\\"hljs-keyword\\\"\u003eimport\u003c/span\u003e { \u003cspan class=\\\"hljs-title class_\\\"\u003eUser\u003c/span\u003e } \u003cspan class=\\\"hljs-keyword\\\"\u003efrom\u003c/span\u003e \u003cspan class=\\\"hljs-string\\\"\u003e\u0026#x27;@prisma/client\u0026#x27;\u003c/span\u003e;\\n\u003cspan class=\\\"hljs-keyword\\\"\u003eimport\u003c/span\u003e express \u003cspan class=\\\"hljs-keyword\\\"\u003efrom\u003c/span\u003e \u003cspan class=\\\"hljs-string\\\"\u003e\u0026#x27;express\u0026#x27;\u003c/span\u003e;\\n\u003cspan class=\\\"hljs-keyword\\\"\u003eimport\u003c/span\u003e jwt \u003cspan class=\\\"hljs-keyword\\\"\u003efrom\u003c/span\u003e \u003cspan class=\\\"hljs-string\\\"\u003e\u0026#x27;jsonwebtoken\u0026#x27;\u003c/span\u003e;\\n\u003cspan class=\\\"hljs-keyword\\\"\u003eimport\u003c/span\u003e passport \u003cspan class=\\\"hljs-keyword\\\"\u003efrom\u003c/span\u003e \u003cspan class=\\\"hljs-string\\\"\u003e\u0026#x27;passport\u0026#x27;\u003c/span\u003e;\\n\\n\u003cspan class=\\\"hljs-keyword\\\"\u003eimport\u003c/span\u003e * \u003cspan class=\\\"hljs-keyword\\\"\u003eas\u003c/span\u003e \u003cspan class=\\\"hljs-title class_\\\"\u003eSession\u003c/span\u003e \u003cspan class=\\\"hljs-keyword\\\"\u003efrom\u003c/span\u003e \u003cspan class=\\\"hljs-string\\\"\u003e\u0026#x27;../controllers/session\u0026#x27;\u003c/span\u003e;\\n\u003cspan class=\\\"hljs-keyword\\\"\u003eimport\u003c/span\u003e { \u003cspan class=\\\"hljs-variable constant_\\\"\u003eJWT_SECRET\u003c/span\u003e } \u003cspan class=\\\"hljs-keyword\\\"\u003efrom\u003c/span\u003e \u003cspan class=\\\"hljs-string\\\"\u003e\u0026#x27;../values\u0026#x27;\u003c/span\u003e;\\n\\n\u003cspan class=\\\"hljs-keyword\\\"\u003econst\u003c/span\u003e router = express.\u003cspan class=\\\"hljs-title class_\\\"\u003eRouter\u003c/span\u003e();\\n\\nrouter.\u003cspan class=\\\"hljs-title function_\\\"\u003epost\u003c/span\u003e(\u003cspan class=\\\"hljs-string\\\"\u003e\u0026#x27;/google\u0026#x27;\u003c/span\u003e, passport.\u003cspan class=\\\"hljs-title function_\\\"\u003eauthenticate\u003c/span\u003e(\u003cspan class=\\\"hljs-string\\\"\u003e\u0026#x27;google-id-token\u0026#x27;\u003c/span\u003e), \u003cspan class=\\\"hljs-title function_\\\"\u003easync\u003c/span\u003e (req, res) =\u0026gt; {\\n    \u003cspan class=\\\"hljs-keyword\\\"\u003econst\u003c/span\u003e session = \u003cspan class=\\\"hljs-keyword\\\"\u003eawait\u003c/span\u003e \u003cspan class=\\\"hljs-title class_\\\"\u003eSession\u003c/span\u003e.\u003cspan class=\\\"hljs-title function_\\\"\u003egetSessionByUser\u003c/span\u003e(req.\u003cspan class=\\\"hljs-property\\\"\u003euser\u003c/span\u003e \u003cspan class=\\\"hljs-keyword\\\"\u003eas\u003c/span\u003e \u003cspan class=\\\"hljs-title class_\\\"\u003eUser\u003c/span\u003e);\\n    \u003cspan class=\\\"hljs-keyword\\\"\u003econst\u003c/span\u003e credentials = jwt.\u003cspan class=\\\"hljs-title function_\\\"\u003esign\u003c/span\u003e(session, \u003cspan class=\\\"hljs-variable constant_\\\"\u003eJWT_SECRET\u003c/span\u003e);\\n    res.\u003cspan class=\\\"hljs-title function_\\\"\u003ejson\u003c/span\u003e({\\n        \u003cspan class=\\\"hljs-attr\\\"\u003edata\u003c/span\u003e: {\\n            \u003cspan class=\\\"hljs-attr\\\"\u003escheme\u003c/span\u003e: \u003cspan class=\\\"hljs-string\\\"\u003e\u0026#x27;Bearer\u0026#x27;\u003c/span\u003e,\\n            credentials,\\n            \u003cspan class=\\\"hljs-attr\\\"\u003eexpiresAt\u003c/span\u003e: session.\u003cspan class=\\\"hljs-property\\\"\u003eexpiresAt\u003c/span\u003e,\\n        },\\n    });\\n});\\n\\n\u003cspan class=\\\"hljs-keyword\\\"\u003eexport\u003c/span\u003e \u003cspan class=\\\"hljs-keyword\\\"\u003edefault\u003c/span\u003e router;\\n\u003c/code\u003e\u003c/pre\u003e\\n\u003cp\u003eNotice that between the path and the callback we add a \u003ccode\u003epassport.authenticate\u003c/code\u003e call to tell the application to enforce the \u003ccode\u003egoogle-id-token\u003c/code\u003e authentication method for this endpoint. Simple as that. If the Google ID token is valid, the callback will run, otherwise it will return a 401 error code.\u003c/p\u003e\\n\u003cp\u003eWith that done, we build a session object and convert it into a valid JSON Web Token. The consumer of this endpoint will want to know the scheme used in the Authentication header (Bearer in this case), the session token (which we send in the credentials property), and when the session expires to improve the user experience.\u003c/p\u003e\\n\u003cp\u003eThere is a small caveat to add at this point. Notice that for each of the three possible environments we have mentioned we are going to need different Google Client IDs. But we have used a single one up until now. To work around this issue we can create one authentication strategy for each environment:\u003c/p\u003e\\n\u003cpre\u003e\u003ccode class=\\\"hljs\\\"\u003epassport.\u003cspan class=\\\"hljs-title function_\\\"\u003euse\u003c/span\u003e(\u003cspan class=\\\"hljs-string\\\"\u003e\u0026#x27;google-id-token-\u0026lt;env\u0026gt;\u0026#x27;\u003c/span\u003e, \u003cspan class=\\\"hljs-title function_\\\"\u003egetGoogleTokenStrategy\u003c/span\u003e(\u003cspan class=\\\"hljs-variable constant_\\\"\u003eGOOGLE_CLIENT_ID_\u003c/span\u003e\u0026lt;\u003cspan class=\\\"hljs-variable constant_\\\"\u003eENV\u003c/span\u003e\u0026gt;));\\n\u003c/code\u003e\u003c/pre\u003e\\n\u003cp\u003eAnd create one endpoint for each environment using each of these strategies.\u003c/p\u003e\\n\u003cp\u003eNow let's move to the message router:\u003c/p\u003e\\n\u003cpre\u003e\u003ccode class=\\\"hljs\\\"\u003e\u003cspan class=\\\"hljs-keyword\\\"\u003eimport\u003c/span\u003e express \u003cspan class=\\\"hljs-keyword\\\"\u003efrom\u003c/span\u003e \u003cspan class=\\\"hljs-string\\\"\u003e\u0026#x27;express\u0026#x27;\u003c/span\u003e;\\n\u003cspan class=\\\"hljs-keyword\\\"\u003eimport\u003c/span\u003e passport \u003cspan class=\\\"hljs-keyword\\\"\u003efrom\u003c/span\u003e \u003cspan class=\\\"hljs-string\\\"\u003e\u0026#x27;passport\u0026#x27;\u003c/span\u003e;\\n\\n\u003cspan class=\\\"hljs-keyword\\\"\u003eimport\u003c/span\u003e * \u003cspan class=\\\"hljs-keyword\\\"\u003eas\u003c/span\u003e \u003cspan class=\\\"hljs-title class_\\\"\u003eMessage\u003c/span\u003e \u003cspan class=\\\"hljs-keyword\\\"\u003efrom\u003c/span\u003e \u003cspan class=\\\"hljs-string\\\"\u003e\u0026#x27;../controllers/message\u0026#x27;\u003c/span\u003e;\\n\\n\u003cspan class=\\\"hljs-keyword\\\"\u003econst\u003c/span\u003e router = express.\u003cspan class=\\\"hljs-title class_\\\"\u003eRouter\u003c/span\u003e();\\n\\nrouter.\u003cspan class=\\\"hljs-title function_\\\"\u003euse\u003c/span\u003e(passport.\u003cspan class=\\\"hljs-title function_\\\"\u003eauthenticate\u003c/span\u003e(\u003cspan class=\\\"hljs-string\\\"\u003e\u0026#x27;jwt\u0026#x27;\u003c/span\u003e, { \u003cspan class=\\\"hljs-attr\\\"\u003esession\u003c/span\u003e: \u003cspan class=\\\"hljs-literal\\\"\u003efalse\u003c/span\u003e }));\\n\\nrouter.\u003cspan class=\\\"hljs-title function_\\\"\u003eget\u003c/span\u003e(\u003cspan class=\\\"hljs-string\\\"\u003e\u0026#x27;/\u0026#x27;\u003c/span\u003e, \u003cspan class=\\\"hljs-title function_\\\"\u003easync\u003c/span\u003e (req, res) =\u0026gt; {\\n    \u003cspan class=\\\"hljs-keyword\\\"\u003econst\u003c/span\u003e message = \u003cspan class=\\\"hljs-keyword\\\"\u003eawait\u003c/span\u003e \u003cspan class=\\\"hljs-title class_\\\"\u003eMessage\u003c/span\u003e.\u003cspan class=\\\"hljs-title function_\\\"\u003egetRandomMessage\u003c/span\u003e();\\n    res.\u003cspan class=\\\"hljs-title function_\\\"\u003ejson\u003c/span\u003e({\\n        \u003cspan class=\\\"hljs-attr\\\"\u003edata\u003c/span\u003e: { message },\\n    });\\n});\\n\\n\u003cspan class=\\\"hljs-keyword\\\"\u003eexport\u003c/span\u003e \u003cspan class=\\\"hljs-keyword\\\"\u003edefault\u003c/span\u003e router;\\n\u003c/code\u003e\u003c/pre\u003e\\n\u003cp\u003eBecause we expect all endpoints to be secured for this part of the application, we enforce JWT authentication at router level with the line:\u003c/p\u003e\\n\u003cpre\u003e\u003ccode class=\\\"hljs\\\"\u003erouter.\u003cspan class=\\\"hljs-title function_\\\"\u003euse\u003c/span\u003e(passport.\u003cspan class=\\\"hljs-title function_\\\"\u003eauthenticate\u003c/span\u003e(\u003cspan class=\\\"hljs-string\\\"\u003e\u0026#x27;jwt\u0026#x27;\u003c/span\u003e, { \u003cspan class=\\\"hljs-attr\\\"\u003esession\u003c/span\u003e: \u003cspan class=\\\"hljs-literal\\\"\u003efalse\u003c/span\u003e }));\\n\u003c/code\u003e\u003c/pre\u003e\\n\u003cp\u003eEverything after that is business logic.\u003c/p\u003e\\n\u003ch1\u003eResults\u003c/h1\u003e\\n\u003cp\u003eAt this point we have a working Login Screen that allows logging in using Google.\u003c/p\u003e\\n\u003cimg src=\\\"/assets/img/2022-01-03-social-login-app/screenshot_login.jpg\\\" alt=\\\"Login Screen\\\" width=\\\"200\\\"/\u003e\\n\u003cp\u003eMoreover, we have a Home Screen that shows authenticated users a random message from the server.\u003c/p\u003e\\n\u003cimg src=\\\"/assets/img/2022-01-03-social-login-app/screenshot_home.jpg\\\" alt=\\\"Home Screen\\\" width=\\\"200\\\"/\u003e\\n\u003cp\u003eAt which point we are done with the tutorial.\u003c/p\u003e\\n\u003ch1\u003eSources\u003c/h1\u003e\\n\u003cul\u003e\\n\u003cli\u003e\u003ca href=\\\"https://github.com/sebasgarcep/social-login-app\\\"\u003eReact Native Application\u003c/a\u003e\u003c/li\u003e\\n\u003cli\u003e\u003ca href=\\\"https://github.com/sebasgarcep/social-login-server\\\"\u003eExpress Application\u003c/a\u003e\u003c/li\u003e\\n\u003c/ul\u003e\\n\",\"tags\":[\"Software Engineering\",\"React Native\",\"Expo\",\"Social Login\",\"Express\",\"Passport\",\"Google\"]},\"previousPost\":{\"id\":\"counting-primes-really-fast\",\"title\":\"Counting Primes Really Fast\"},\"nextPost\":{\"id\":\"kalman-filter-tutorial\",\"title\":\"Understanding the Kalman Filter\"}}},\"actionData\":null,\"errors\":null}");</script></div>
<script>window.__VITE_REACT_SSG_HASH__ = '5nu5556din'</script>


</body></html>